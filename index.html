<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW G20 Dynamic Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .content-item h3 { font-size: 1.25rem; font-weight: 700; color: #1e3a8a; }
        .content-item h3 span { font-size: 0.875rem; font-weight: 500; color: #64748b; }
        .content-item ul { list-style-type: none; padding-left: 0; }
        .content-item li { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem; }
        .content-item li strong { color: #1e3a8a; display: block; margin-bottom: 0.25rem; }
        .content-item li code { background-color: #e2e8f0; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-family: monospace; }
        .sidebar-item { transition: background-color 0.2s ease, color 0.2s ease; }
        .sidebar-item.active { background-color: #1d4ed8; color: white; }
        .sidebar-header { font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; }
        #ai-response .ai-card { background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 1rem; overflow: hidden; }
        #ai-response .ai-card-header { padding: 0.75rem 1rem; font-weight: bold; color: white; display: flex; align-items: center; }
        #ai-response .ai-card-body { padding: 1rem; }
        #ai-response .ai-card-body strong { color: #1e3a8a; }

        /* Accordion styles */
        details { border: 1px solid #e5e7eb; border-radius: 0.5rem; margin-bottom: 0.5rem; }
        summary { cursor: pointer; padding: 1rem; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        summary::-webkit-details-marker { display: none; }
        details[open] summary { border-bottom: 1px solid #e5e7eb; }
        .accordion-content { padding: 1rem; }
        summary::after { content: '+'; font-size: 1.5rem; transition: transform 0.2s; }
        details[open] summary::after { transform: rotate(45deg); }

    </style>
</head>
<body class="bg-gray-200 text-gray-800">

    <div class="min-h-screen flex items-center justify-center p-0 md:p-4">
        <div class="max-w-7xl w-full h-screen md:h-[calc(100vh-4rem)] bg-white md:rounded-2xl shadow-2xl flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-gray-900 text-white w-72 flex-shrink-0 absolute md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 z-40 sidebar">
                <div class="p-5">
                    <h2 class="text-2xl font-bold">BMW G20 Guide</h2>
                </div>
                <nav class="flex-grow p-4 space-y-2 overflow-y-auto">
                <div>
                    <h3 class="sidebar-header text-sm px-2 mb-2">Tools</h3>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="welcome">Welcome</a>
                </div>
                <div>
                    <h3 class="sidebar-header text-sm px-2 mb-2 flex items-center">
                        <span class="bg-green-500 w-2.5 h-2.5 rounded-full mr-2"></span>
                        BimmerLink
                    </h3>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="bimmerlink-exhaust">Exhaust Flap Control</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="bimmerlink-battery">Battery Registration</a>
                </div>

                <div>
                    <h3 class="sidebar-header text-sm px-2 mb-2 flex items-center">
                         <span class="bg-blue-500 w-2.5 h-2.5 rounded-full mr-2"></span>
                        BimmerCode
                    </h3>
                     <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="asd">Active Sound Design (ASD)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="acsm">Advanced Crash Safety (ACSM)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="bdc">Body Domain Controller (BDC)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="hu_mgu">Headunit (HU_MGU)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="dkombi">Instrument Cluster (DKOMBI)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="hkfm">Tailgate Function (HKFM)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="ihka">Air Conditioning (IHKA)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="kafas">Camera System (KAFAS)</a>
                </div>
                <div>
                     <h3 class="sidebar-header text-sm px-2 mb-2 flex items-center">
                         <span class="bg-red-500 w-2.5 h-2.5 rounded-full mr-2"></span>
                        BimmerUtility
                    </h3>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="dme">Engine Control Unit (DME)</a>
                    <a href="#" class="sidebar-item block py-2 px-2 rounded hover:bg-gray-700" data-content="egs">Transmission Control (EGS)</a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center z-10">
                <div class="flex items-center">
                    <button id="menu-toggle" class="md:hidden p-2 rounded-md text-gray-600 hover:bg-gray-200 mr-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 12h-8" />
                        </svg>
                    </button>
                    <h1 id="content-title" class="text-xl md:text-2xl font-semibold text-gray-700 truncate">Welcome</h1>
                </div>
                <button id="ai-header-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2zM5.05 5.05a.75.75 0 011.06 0l1.062 1.062a.75.75 0 01-1.06 1.06L5.05 6.11a.75.75 0 010-1.06zm9.9 0a.75.75 0 010 1.06l-1.062 1.062a.75.75 0 11-1.06-1.06L14.95 5.05a.75.75 0 011.06 0zM2 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 012 10zm14.25.75a.75.75 0 000-1.5h1.5a.75.75 0 000 1.5h-1.5zM5.05 14.95a.75.75 0 010-1.06l1.062-1.062a.75.75 0 111.06 1.06L6.11 14.95a.75.75 0 01-1.06 0zm9.9 0a.75.75 0 01-1.06 0l-1.062-1.062a.75.75 0 111.06-1.06L14.95 13.89a.75.75 0 010 1.06zM10 18a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5A.75.75 0 0110 18z" clip-rule="evenodd" />
                    </svg>
                    <span>Ask Gemini</span>
                </button>
            </header>
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50">
                <!-- Dynamic Content Loads Here -->
            </div>
        </main>
    </div>
</div>

    <!-- Mobile Sidebar Backdrop -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- AI Modal -->
    <div id="ai-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-40 hidden"></div>
    <div id="ai-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-2xl bg-gray-50 rounded-2xl shadow-2xl z-50 hidden transform transition-all flex flex-col max-h-[85vh] p-6 md:p-8">
        <!-- AI Assistant content will be injected here -->
    </div>
    <!-- End Floating AI Button and Modal -->

    <!-- AI Assistant Staging Area -->
    <div id="ai-assistant-staging" class="hidden">
        <div id="ai-assistant-container" class="bg-white p-4 md:p-8 rounded-2xl shadow-lg h-full flex flex-col overflow-hidden">
             <div id="ai-assistant" class="h-full flex flex-col overflow-hidden">
                <h3 class="text-2xl font-bold text-blue-700 mb-3">AI Coding Assistant</h3>
                <p class="text-gray-600 mb-4">Describe the feature you want to code (e.g., "Enable Sport+ mode" or "Disable auto start/stop"), and the AI will generate the required steps.</p>
                <div class="mb-4">
                    <textarea id="ai-prompt" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" rows="3" placeholder="e.g., Enable Bowers & Wilkins sound settings..."></textarea>
                </div>
                <button id="ai-submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center w-full sm:w-auto">
                    <span id="ai-submit-text">Generate Steps</span>
                    <div id="ai-spinner" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin ml-2 hidden"></div>
                </button>
                <div class="mt-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-md text-sm">
                    <strong>Disclaimer:</strong> Expert mode modifications can be complex. Always back up your vehicle's data before making changes. The generated steps are for informational purposes. Proceed at your own risk.
                </div>
                <div id="ai-response" class="mt-6 prose max-w-none flex-grow overflow-y-auto"></div>
                <div id="export-controls" class="relative hidden mt-4 text-right pt-4 border-t">
                    <button id="export-button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center ml-auto">
                        Export As
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="export-dropdown" class="absolute right-0 bottom-10 w-48 bg-white rounded-md shadow-lg z-10 hidden">
                        <a href="#" id="export-png" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as PNG</a>
                        <a href="#" id="export-pdf" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as PDF</a>
                        <a href="#" id="export-html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Download as HTML</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Templates -->
    <template id="template-welcome">
        <div class="space-y-8">
            <div class="bg-white p-4 md:p-8 rounded-2xl shadow-lg">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to the Interactive G20 Guide</h2>
                <p class="text-lg text-gray-600 mb-3">
                    Your one-stop resource for BMW G20 coding. This guide provides detailed, step-by-step instructions for popular modifications using <strong>BimmerCode</strong>, <strong>BimmerLink</strong>, and <strong>BimmerUtility</strong>.
                </p>
                <p class="text-lg text-gray-600">
                    Use the menu to navigate through different modules, or use the AI Assistant below to get instructions for a specific feature.
                </p>
            </div>

            <div id="welcome-ai-placeholder"></div>
        </div>
    </template>
    
    <template id="template-bimmerlink-exhaust">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Exhaust Flap Control</h3><p class="mb-4">BimmerLink allows you to manually open or close the exhaust flap(s) for sound control. This is not a permanent coding change; the flap will revert to its default behavior after a driving cycle.</p><ul><li><strong>Step 1:</strong> Connect BimmerLink to your vehicle via a compatible OBD adapter.</li><li><strong>Step 2:</strong> From the main dashboard, select "Exhaust Flap".</li><li><strong>Step 3:</strong> Tap the button to toggle the flap between "Open", "Closed", and "Automatic" (default).</li></ul></div>
    </template>

    <template id="template-bimmerlink-battery">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>New Battery Registration</h3><p class="mb-4">When replacing your vehicle's battery, you must register the new one with the car's electrical system. This ensures the charging system works correctly for the new battery's capacity and type, prolonging its life.</p><ul><li><strong>Step 1:</strong> After installing the new battery, connect BimmerLink.</li><li><strong>Step 2:</strong> Navigate to the "Battery" section.</li><li><strong>Step 3:</strong> Tap "Register new battery".</li><li><strong>Step 4:</strong> Select the capacity (e.g., 90Ah, 105Ah) and type (e.g., AGM) that matches the newly installed battery. Confirm the registration.</li></ul></div>
    </template>
    
    <template id="template-asd">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Active Sound Design <span>(ASD)</span></h3><p class="mb-4">Controls the synthesized engine sound played through the vehicle's speakers.</p><ul><li><strong>Deactivate ASD:</strong> Find <code>ASD_SOUND_OFF</code> and set it to <code>aktiv</code>. This will disable the feature.</li></ul></div>
    </template>
    
    <template id="template-acsm">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Advanced Crash Safety Module <span>(ACSM)</span></h3><p class="mb-4">Manages seatbelt reminders and other safety features.</p><ul><li><strong>Disable Seatbelt Chimes (Driver):</strong> Set <code>SBR_FAHRER_SBR_DISABLE</code> to <code>aktiv</code>.</li><li><strong>Disable Seatbelt Chimes (Passenger):</strong> Set <code>SBR_BEIFAHRER_SBR_DISABLE</code> to <code>aktiv</code>.</li></ul></div>
    </template>
    
    <template id="template-bdc">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Body Domain Controller <span>(BDC / FEM)</span></h3><p class="mb-4">Controls a wide range of body functions like lighting, windows, mirrors, and locking.</p><ul><li><strong>5-Blink Turn Signal:</strong> Set <code>BLINKZYKLEN_ANZAHL_TIPP</code> to <code>Werte=04</code> (for 5 blinks).</li><li><strong>Window Roll-up on Door Open:</strong> Allow windows to continue closing when a door is opened by by setting <code>FH_TUERAUF_STOP_MAUT</code> to <code>nicht_aktiv</code>.</li><li><strong>No Horn on Lock with Engine Running:</strong> Set <code>VAM_HORN_AT_SECURE</code> to <code>nicht_aktiv</code>.</li><li><strong>Rear Lamps as Daytime Running Lights:</strong> Set <code>MAPPING_TAGFAHRL_H_L_OUTPUT</code> and <code>MAPPING_TAGFAHRL_H_R_OUTPUT</code> to <code>sl_l</code> and <code>sl_r</code> respectively.</li><li><strong>Enable Wireless Charging Tray:</strong> For retrofits, find <code>WIRELESS_CHARGING_TRAY</code> and set it to <code>aktiv</code>.</li><li><strong>Enable Paddle Shifters (for Retrofit):</strong> This coding is for cars where paddle shifters have been physically installed. In BDC, find <code>PADDLES_VERBAUT</code> and set to <code>aktiv</code>. If this is not enough, the Sport Automatic Transmission option (<code>2TB</code>) may need to be added to the vehicle order with BimmerUtility.</li></ul></div>
    </template>
    
    <template id="template-hu_mgu">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Headunit <span>(HU_MGU)</span></h3><p class="mb-4">Governs the iDrive system, display, and media functions.</p><ul><li><strong>M Startup Animation:</strong> Change <code>STARTUP_EMBLEM</code> to <code>bmw_m</code>.</li><li><strong>Rear Camera Zoom (Towbar):</strong> Set <code>MACRO_TRAILER_COUPLING</code> to <code>aktiv</code>.</li><li><strong>Remove iDrive & Camera Disclaimers:</strong> Set <code>LEGAL_DISCLAIMER_TIME</code> to <code>kein_ld</code> and <code>MACRO_CAM_LEGALDISCLAIMER</code> to <code>nicht_aktiv</code>.</li><li><strong>Tire Pressure & Temperature Display:</strong> Set <code>RDC_DRUCK_TEMP</code> to <code>druck_und_temperatur</code>.</li><li><strong>Video in Motion:</strong> Set <code>SPEEDLOCK_X_KMH_MAX</code> and <code>SPEEDLOCK_X_KMH_MIN</code> to <code>FF</code>.</li><li><strong>Bang & Olufsen Sound Profile:</strong> Set <code>AUDIO_SYSTEM</code> to <code>bang_olufsen</code> or similar available value.</li></ul></div>
    </template>

    <template id="template-dkombi">
        <div class="content-item bg-white p-6 rounded-lg shadow">
            <h3>Instrument Cluster <span>(DKOMBI)</span></h3>
            <p class="mb-4">This guide provides detailed steps to enable the M Performance theme on your instrument cluster using Bimmercode's Expert Mode.</p>

            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Step 1: Connect to Your Vehicle</h4>
            <ul class="list-disc list-inside space-y-2">
                <li>Plug your OBD2 adapter into your car's OBD2 port (located in the driver-side footwell, usually above the pedals).</li>
                <li>Turn on your car's ignition by pressing the start button without your foot on the brake. The car's electronics should be on, but not the engine.</li>
                <li>Connect your phone to the OBD2 adapter (via Wi-Fi or Bluetooth, depending on the adapter).</li>
                <li>Open the Bimmercode app, select your adapter, and tap "Connect".</li>
            </ul>

            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Step 2: Navigate to the Instrument Cluster Module</h4>
            <ul class="list-disc list-inside space-y-2">
                <li>After Bimmercode reads your vehicle's data, it will display a list of Electronic Control Units (ECUs).</li>
                <li>Scroll down and select "Instrument Cluster". The technical name for this ECU is often <code>DKOMBI4</code>.</li>
            </ul>

            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Step 3: Enter Expert Mode</h4>
            <ul class="list-disc list-inside space-y-2">
                <li>The app will first show you a list of common, pre-configured coding options. For this change, you need to use Expert Mode.</li>
                <li>Scroll to the bottom of the list and tap on "Expert Mode".</li>
                <li>Read and accept the warning message to proceed.</li>
            </ul>

            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Step 4: Modify the Parameters</h4>
            <p class="mb-2">You are now in a more detailed, text-based editor. Use the search bar at the top to find and change the following two parameters precisely as described.</p>

            <h5 class="font-semibold text-md text-gray-800 mt-3 mb-1">First Parameter (Logo)</h5>
            <ul class="list-disc list-inside space-y-2">
                <li>Search for: <code>Logo_Ausgabetyp</code></li>
                <li>Tap on it.</li>
                <li>Change the value from <code>bmw</code> (or whatever it is currently) to <code>m_gmbh</code>.</li>
                <li>Tap "OK".</li>
            </ul>

            <h5 class="font-semibold text-md text-gray-800 mt-3 mb-1">Second Parameter (M View)</h5>
            <ul class="list-disc list-inside space-y-2">
                <li>Search for: <code>Darstellung_Sonderdarstellung</code></li>
                <li>Tap on it.</li>
                <li>Change the value from the current setting to <code>aktiv</code>.</li>
                <li>Tap "OK".</li>
            </ul>

            <h4 class="font-bold text-lg text-blue-700 mt-4 mb-2">Step 5: Apply the Code</h4>
            <p>After modifying the parameters, go back one screen and tap the "Code" button at the top right. Bimmercode will write the changes to your car. Wait for the process to complete, and the instrument cluster will restart to display the new M Performance theme.</p>
        </div>
    </template>
    
    <template id="template-hkfm">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Tailgate Function Module <span>(HKFM / TFM)</span></h3><p class="mb-4">Controls the powered tailgate.</p><ul><li><strong>Open/Close Trunk with Short Press (Remote & Interior):</strong> Set <code>HFINAL_ Kurz</code>, <code>HFINAL_Lang</code>, <code>TASTER_KURZ</code>, and <code>TASTER_LANG</code> all to <code>nicht_aktiv (close)</code> / <code>aktiv (open)</code> as needed to remove long-press requirement.</li></ul></div>
    </template>
    
    <template id="template-ihka">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Air Conditioning <span>(IHKA)</span></h3><p class="mb-4">Controls the climate system.</p><ul><li><strong>A/C System Memory:</strong> Set <code>OFF_MEMORY</code> to <code>aktiv</code>.</li><li><strong>Enable Auto Steering Wheel Heat:</strong> Set <code>LENKRADHEIZUNG_AUTO_Aktiv</code> to <code>aktiv</code> (requires appropriate hardware).</li></ul></div>
    </template>
    
    <template id="template-kafas">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Camera-Based Driver Assistance <span>(KAFAS)</span></h3><p class="mb-4">Controls systems like lane assist and high beams.</p><ul><li><strong>Enable Anti-Dazzle High-Beam Assistant (Full):</strong> This is a complex coding that requires changing multiple values (<code>C_FLA_BS_ENTER_THRESH</code>, <code>C_FLA_BS_EXIT_THRESH</code>, etc.) in KAFAS and BDC. It is best handled by the AI assistant for a full walkthrough.</li><li><strong>Lane Change Assistant:</strong> Set <code>SPURWECHSEL_ASSISTENT</code> to <code>aktiv</code>.</li></ul></div>
    </template>
    
    <template id="template-dme">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Engine Control Unit <span>(DME) - BimmerUtility</span></h3><p class="mb-4"><strong>WARNING:</strong> Modifying the engine ECU is for advanced users and can affect performance and warranty.</p>
            <ul>
                <li><strong>Auto Start-Stop Memory:</strong> Set <code>TC_MSA_MEMORY</code> to <code>aktiv</code>.</li>
                <li><strong>Default Driving Mode on Startup:</strong> Set <code>TCM_DEFAULT_DRIVING_MODE</code> to your desired mode (e.g., <code>0x02</code> for Sport, <code>0x07</code> for Adaptive).</li>
                <li><strong>Enable Coasting in Comfort Mode:</strong> Set <code>ECO_COASTING</code> to <code>aktiv</code>.</li>
                <li><strong>Enable Sport+ & Comfort+:</strong> This is a multi-stage process.
                    <br><br>1. <strong>In DME (BimmerUtility):</strong> Set <code>FesSportWorldMode1</code> to <code>aktiv</code>.
                    <br>2. <strong>In Headunit (BimmerCode):</strong> Add "Sport+" and "Comfort+" to the driving modes list. Find <code>FES_MODES_ADDITIONAL</code> and ensure they are enabled.
                    <br>3. <strong>In Instrument Cluster (BimmerCode):</strong> Find <code>MODUS_SPORT_PLUS</code> and set to <code>aktiv</code>.</li>
                <li><strong>Assisted Driving View:</strong> This requires specific hardware (KAFAS camera).
                    <br><br>1. <strong>In DME (BimmerUtility):</strong> Set <code>Cb_Assistview_gen_M</code> to <code>gen_M</code>.
                    <br>2. <strong>In Headunit (BimmerCode):</strong> Find <code>ASSISTED_DRIVING_VIEW</code> and set to <code>aktiv</code>.</li>
            </ul>
        </div>
    </template>

    <template id="template-egs">
        <div class="content-item bg-white p-6 rounded-lg shadow"><h3>Transmission Control Unit <span>(EGS) - BimmerUtility</span></h3><p class="mb-4"><strong>WARNING:</strong> Changes to the transmission ECU can alter shift behavior significantly.</p><ul><li><strong>Enable Sport Automatic Transmission (2TB):</strong> This procedure enables faster shifts and Launch Control by changing the vehicle order (FA).<br><br><strong>Step 1 (BimmerUtility):</strong> Connect and go to <code>Vehicle Profile > Vehicle Order</code>.<br><strong>Step 2 (BimmerUtility):</strong> Find the SALAPA-Elements list, tap 'Edit', and add <code>2TB</code> to the list. Save the changes to the vehicle order.<br><strong>Step 3 (BimmerUtility):</strong> Return to the ECU list and select the <code>EGS (Transmission Control Unit)</code>.<br><strong>Step 4 (BimmerUtility):</strong> Tap the 'Code' button. This applies the new configuration based on the updated vehicle order.<br><strong>Step 5:</strong> After coding is complete, clear any potential error codes and restart the vehicle.</li></ul></div>
    </template>
    

    <script>
        function toggleAIModal(forceOpen = false) {
            const aiModal = document.getElementById('ai-modal');
            const aiModalBackdrop = document.getElementById('ai-modal-backdrop');
            if (!aiModal || !aiModalBackdrop) return;

            const isHidden = aiModal.classList.contains('hidden');
            if (forceOpen) {
                if (isHidden) {
                    aiModal.classList.remove('hidden');
                    aiModalBackdrop.classList.remove('hidden');
                }
            } else {
                aiModal.classList.toggle('hidden');
                aiModalBackdrop.classList.toggle('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            const contentArea = document.getElementById('content-area');
            const contentTitle = document.getElementById('content-title');
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            const aiHeaderButton = document.getElementById('ai-header-button');
            const aiModalBackdrop = document.getElementById('ai-modal-backdrop');
            const aiAssistantContainer = document.getElementById('ai-assistant-staging').querySelector('#ai-assistant-container');
            const aiModal = document.getElementById('ai-modal');

            function toggleSidebar() {
                sidebar.classList.toggle('-translate-x-full');
                sidebarBackdrop.classList.toggle('hidden');
                document.body.classList.toggle('overflow-hidden');
            }

            menuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleSidebar();
            });
            
            sidebarBackdrop.addEventListener('click', toggleSidebar);

            function loadContent(id) {
                const template = document.getElementById(`template-${id}`);
                if (!template) return;

                contentArea.innerHTML = template.innerHTML;
                const selectedItem = document.querySelector(`.sidebar-item[data-content="${id}"]`);
                contentTitle.textContent = selectedItem ? selectedItem.textContent : 'Guide';

                if (id === 'welcome') {
                    const placeholder = contentArea.querySelector('#welcome-ai-placeholder');
                    if (placeholder) {
                        placeholder.appendChild(aiAssistantContainer);
                    }
                    aiHeaderButton.classList.add('hidden');
                } else {
                    aiModal.appendChild(aiAssistantContainer);
                    aiHeaderButton.classList.remove('hidden');
                }

                setupAIListeners();
                setupExportListeners();
            }

            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const contentId = e.currentTarget.dataset.content;
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadContent(contentId);
                    if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                        toggleSidebar();
                    }
                });
            });

            aiHeaderButton.addEventListener('click', () => toggleAIModal(true));
            aiModalBackdrop.addEventListener('click', () => toggleAIModal());

            function setupAIListeners() {
                const aiSubmitBtn = document.getElementById('ai-submit');
                const aiPrompt = document.getElementById('ai-prompt');
                if (aiSubmitBtn) {
                    aiSubmitBtn.onclick = handleAISubmit;
                }
                if (aiPrompt) {
                    aiPrompt.onkeydown = (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            handleAISubmit();
                        }
                    };
                }
            }
            
            async function handleAISubmit() {
                const promptText = document.getElementById('ai-prompt').value;
                const responseContainer = document.getElementById('ai-response');
                const submitBtn = document.getElementById('ai-submit');
                const btnText = document.getElementById('ai-submit-text');
                const spinner = document.getElementById('ai-spinner');
                const exportControls = document.getElementById('export-controls');

                if (!promptText.trim()) return;

                submitBtn.disabled = true;
                btnText.textContent = 'Generating...';
                spinner.classList.remove('hidden');
                responseContainer.innerHTML = '';
                exportControls.classList.add('hidden');

                try {
                    const result = await callGeminiAPI(promptText);
                    responseContainer.innerHTML = result;
                    if (result && !result.startsWith('<p class="text-red-600')) {
                        exportControls.classList.remove('hidden');
                    }
                } catch (error) {
                    responseContainer.innerHTML = `<p class="text-red-600 font-semibold">An error occurred. Please try again later. Check the browser console for details.</p>`;
                } finally {
                    submitBtn.disabled = false;
                    btnText.textContent = 'Generate Steps';
                    spinner.classList.add('hidden');
                }
            }

            async function callGeminiAPI(prompt) {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw2iJG2TF-ZQC6llieCC8JJHdVNKEQ3SpsjlbyA9gpgWQmdNInS6_hewUDsi0ilSW4F/exec';
                const systemPrompt = `You are an expert on BMW G20 coding. Your task is to provide clear, step-by-step instructions for coding features using BimmerCode or BimmerUtility Expert Mode.

                **RESPONSE FORMATTING RULES:**
                1.  **Main Container:** Enclose the entire response within a single \`<div>\`.
                2.  **Collapsible Sections:** For each tool (BimmerCode, BimmerUtility), create a collapsible accordion section using the \`<details>\` tag. The first section should be open by default (\`<details open>\`).
                3.  **Accordion Header:** The header for each section must be a \`<summary>\` tag. For BimmerCode, use \`<summary style="background-color: #2563eb; color: white;">BimmerCode Steps</summary>\`. For BimmerUtility, use \`<summary style="background-color: #dc2626; color: white;">BimmerUtility Steps</summary>\`.
                4.  **Accordion Content:** The content for each section must be inside a \`<div class="accordion-content">\`.
                5.  **ECU Sections:** Inside the accordion content, start each new ECU with an \`<h3>\` tag containing the ECU's common name and official name (e.g., \`<h3>Headunit (HU_MGU)</h3>\`).
                6.  **Instructions List:** Use an unordered list \`<ul>\` for the steps. Each step must be a list item \`<li>\`.
                7.  **Text Formatting:** Use \`<strong>\` for the feature name (e.g., \`<strong>Video in Motion:</strong>\`). Use \`<code>\` tags for parameter names and values (e.g., \`Set <code>SPEEDLOCK_X_KMH_MAX</code> to <code>FF</code>\`).
                8.  **Clarity:** If a feature cannot be coded, state that clearly in a simple paragraph within the accordion content.

                **CODING KNOWLEDGE RULES:**
                *   Provide the full, official ECU name (e.g., HU_MGU, BDC, DKOMBI) and the common name.
                *   If a feature needs coding in multiple ECUs, create a separate \`<h3>\` section for each ECU within the same tool's accordion.
                *   Do not include any disclaimers or warnings; focus only on the technical steps in the specified format.

                **TOOL-SPECIFIC ECU ACCESS RULES (IMPORTANT!):**
                *   **BimmerCode** can ONLY access: ASD, ACSM, BDC, HU_MGU, DKOMBI, HKFM, IHKA, KAFAS.
                *   **BimmerUtility** can ONLY access: DME, EGS.
                *   **BimmerLink** can ONLY access: Exhaust Flap Control, Battery Registration. It does NOT do coding.
                *   NEVER suggest coding an ECU with a tool that cannot access it. For example, do not suggest coding DME with BimmerCode.`;
                const fullPrompt = `${systemPrompt}\n\nUser request: ${prompt}`;
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ prompt: fullPrompt }), mode: 'cors' });
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const text = await response.text();
                try {
                    const parsed = JSON.parse(text);
                    if (parsed.error) throw new Error(`Apps Script Error: ${parsed.error}`);
                } catch(e) {}
                return text;
            }

            function setupExportListeners() {
                const exportButton = document.getElementById('export-button');
                const exportDropdown = document.getElementById('export-dropdown');
                if (!exportButton) return;

                exportButton.onclick = (e) => {
                    e.stopPropagation();
                    exportDropdown.classList.toggle('hidden');
                };

                document.onclick = (event) => {
                    if (!exportButton.contains(event.target) && !exportDropdown.contains(event.target)) {
                        exportDropdown.classList.add('hidden');
                    }
                };

                document.getElementById('export-png').onclick = () => exportResponse('png');
                document.getElementById('export-pdf').onclick = () => exportResponse('pdf');
                document.getElementById('export-html').onclick = () => exportResponse('html');
            }

            function exportResponse(format) {
                const { jsPDF } = window.jspdf;
                const responseContainer = document.getElementById('ai-response');
                const originalTitle = document.title;
                document.title = 'BMW G20 Coding Report';

                // --- HTML Export ---
                if (format === 'html') {
                    const styles = Array.from(document.styleSheets).map(s => {
                        try {
                            return Array.from(s.cssRules).map(r => r.cssText).join('\n');
                        } catch (e) {
                            return ''; // Ignore CORS-related errors on external stylesheets
                        }
                    }).join('\n');

                    const htmlContent = `
                        <!DOCTYPE html>
                        <html lang="en">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <title>BMW G20 Coding Report</title>
                            <script src="https://cdn.tailwindcss.com"><\/script>
                            <style>${styles}</style>
                        </head>
                        <body class="bg-gray-100 p-8">
                            <h1 class="text-3xl font-bold text-blue-800 mb-6">AI-Generated Coding Report</h1>
                            <div class="prose max-w-none">${responseContainer.innerHTML}</div>
                        </body>
                        </html>`;
                    const blob = new Blob([htmlContent], { type: 'text/html' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = 'coding-report.html';
                    link.click();
                    URL.revokeObjectURL(link.href);
                    document.title = originalTitle;
                    return;
                }

                // --- PNG/PDF Export ---
                // Temporarily modify styles to capture full scrollable content
                const originalHeight = responseContainer.style.height;
                const originalOverflow = responseContainer.style.overflowY;
                responseContainer.style.height = 'auto';
                responseContainer.style.overflowY = 'visible';

                html2canvas(responseContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#f8fafc',
                    windowHeight: responseContainer.scrollHeight, // Ensure canvas is tall enough
                    scrollY: -window.scrollY
                }).then(canvas => {
                    // Restore original styles
                    responseContainer.style.height = originalHeight;
                    responseContainer.style.overflowY = originalOverflow;

                    if (format === 'png') {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = 'coding-report.png';
                        link.click();
                    } else if (format === 'pdf') {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save('coding-report.pdf');
                    }
                    document.title = originalTitle;
                }).catch(err => {
                    // Restore styles even if export fails
                    responseContainer.style.height = originalHeight;
                    responseContainer.style.overflowY = originalOverflow;
                    console.error('Export failed:', err);
                    alert('Could not export the report. Please see the console for details.');
                    document.title = originalTitle;
                });
            }

            const welcomeItem = document.querySelector('.sidebar-item[data-content="welcome"]');
            welcomeItem.classList.add('active');
            loadContent('welcome');
        });
    </script>
</body>
</html>