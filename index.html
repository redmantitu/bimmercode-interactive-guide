<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW Software Works - Ultimate Guide & Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    colors: {
                        primary: { DEFAULT: '#0066B1', light: '#E6F0F7', dark: '#004C8C' },
                        accent: { DEFAULT: '#34D399', light: '#EBFBF5' },
                        neutral: { 50: '#F8FAFC', 100: '#F1F5F9', 200: '#E2E8F0', 300: '#CBD5E1', 400: '#94A3B8', 500: '#64748B', 600: '#475569', 700: '#334155', 800: '#1E293B', 900: '#0F172A' }
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        highlight: { '0%': { backgroundColor: 'rgba(0, 102, 177, 0.1)' }, '100%': { backgroundColor: 'transparent' } }
                    },
                    animation: {
                        fadeIn: 'fadeIn 0.4s ease-out forwards',
                        highlight: 'highlight 1.5s ease-out',
                    }
                },
            },
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #E2E8F0; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: fadeIn 0.3s ease-in-out; }
        .chevron { transition: transform 0.3s ease; }
        details[open] summary .chevron { transform: rotate(180deg); }

        /* Chat Modal Animation */
        #chat-panel {
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
            transform: translateY(110%); /* Start hidden below screen */
            z-index: 500; /* High z-index to cover everything */
        }
        body.chat-open #chat-panel {
            transform: translateY(0); /* Slide up to cover screen */
        }
        body.chat-open {
            overflow: hidden; /* Prevent scrolling background when chat is open */
        }

        /* Hide FAB when chat is open */
        #open-chat-btn {
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 9999; /* Increased to ensure visibility */
            bottom: 1.5rem; /* Fallback for mobile */
            right: 1.5rem; /* Fallback for mobile */
        }
        body.chat-open #open-chat-btn {
            transform: translateY(200%);
            opacity: 0;
            pointer-events: none;
        }

        /* Markdown Content Styles */
        .md-content h5 { font-size: 1.1rem; font-weight: 700; color: #1E293B; margin-top: 1rem; margin-bottom: 0.5rem; }
        .md-content p { margin-bottom: 0.75rem; line-height: 1.6; color: #334155; }
        .md-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; color: #334155; }
        .md-content ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; color: #334155; }
        .md-content li { margin-bottom: 0.25rem; }
        .md-content strong { color: #0F172A; font-weight: 600; }
        .md-content code { background: #E2E8F0; color: #DD1144; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-family: 'Fira Code', monospace; font-size: 0.9em; }
        .md-content pre { background: #0F172A; color: #F1F5F9; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; position: relative; }
        .md-content pre code { background: transparent; color: inherit; padding: 0; }
        .md-content a { color: #0066B1; text-decoration: underline; }

        /* Wizard Modal */
        #wizard-modal { transition: opacity 0.2s ease, visibility 0.2s; visibility: hidden; opacity: 0; }
        #wizard-modal.open { visibility: visible; opacity: 1; }
        #wizard-content { transform: scale(0.95); transition: transform 0.2s ease; }
        #wizard-modal.open #wizard-content { transform: scale(1); }

        /* Table Styles */
        .code-table th { text-align: left; padding: 0.75rem 1rem; background: #F8FAFC; color: #475569; font-weight: 600; border-bottom: 1px solid #E2E8F0; }
        .code-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #E2E8F0; color: #334155; font-size: 0.9rem; }
        .code-table tr:last-child td { border-bottom: none; }
        .code-table code { background: #EFF6FF; color: #0066B1; padding: 2px 6px; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.85rem; }
        
        /* Highlight Animation */
        .target-highlight { animation: highlight 1.5s ease-out; }
        
        /* Tab switching */
        .tab-btn.active { background-color: #0066B1; color: white; }
    </style>
</head>
<body class="text-neutral-800 antialiased h-screen w-screen overflow-x-hidden relative bg-white">

    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-primary-light via-white to-accent-light opacity-20 pointer-events-none z-0"></div>

    <div id="app-wrapper" class="h-full w-full">

        <!-- PANEL 1: THE GUIDE (Always Visible) -->
        <div id="guide-panel" class="w-full h-full flex flex-col">
            <header class="sticky top-0 z-20 bg-white/70 backdrop-blur-lg border-b border-neutral-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 bg-primary flex items-center justify-center rounded-lg text-white font-bold text-lg shadow-lg shadow-primary/20">B</div>
                        <h1 class="text-lg font-semibold text-neutral-900 tracking-tight">BMW Software Guide</h1>
                    </div>
                    <nav class="hidden lg:flex items-center gap-6 text-sm font-medium text-neutral-500">
                        <a href="#part-1" class="hover:text-primary transition-colors">Setup</a>
                        <a href="#part-2" class="hover:text-primary transition-colors">BimmerCode</a>
                        <a href="#part-8" class="hover:text-primary transition-colors">BimmerUtility</a>
                        <a href="#part-esys" class="hover:text-primary transition-colors">E-Sys</a>
                        <a href="#part-service" class="hover:text-primary transition-colors">Service History</a>
                        <a href="#part-6" class="hover:text-primary transition-colors">Diagnostics</a>
                    </nav>
                </div>
            </header>
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 scroll-smooth pb-24">
                <div class="max-w-4xl mx-auto space-y-6">
                    <div class="text-center py-10 animate-fadeIn">
                        <h2 class="text-4xl md:text-5xl font-bold text-neutral-900 mb-3 tracking-tight">G-Chassis Developer Guide</h2>
                        <p class="text-lg text-neutral-500 max-w-2xl mx-auto">The essential guide to diagnostics, programming, and coding for modern BMWs (G20, G80, etc.).</p>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-2xl p-6 flex gap-4 items-start animate-fadeIn" style="animation-delay: 0.1s;">
                        <div class="flex-shrink-0 text-red-500 mt-1"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L1 21h22L12 2zm1 15h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div>
                        <div>
                            <h3 class="text-lg font-bold text-red-800 mb-2">Critical Safety Warning</h3>
                            <p class="text-red-700 mb-3">Modifying your vehicle's electronic systems involves significant risk.</p>
                            <ul class="list-disc list-inside text-sm text-red-600 space-y-1.5">
                                <li><strong>Stable Power is Mandatory:</strong> For any programming or flashing, a <strong>50A+ voltage-stable power supply</strong> is non-negotiable.</li>
                                <li><strong>Irreversible Damage Risk:</strong> An interrupted flash can permanently "brick" essential control units (MGU, DME).</li>
                                <li><strong>Expert Mode Disclaimer:</strong> Standard coding is safe. Expert Mode (editing raw values) bypasses safety checks and is done at your own risk.</li>
                            </ul>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <!-- SETUP -->
                        <details id="part-1" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm" open>
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-primary-light p-3 rounded-lg text-primary"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">1. Connection & Hardware</h3><p class="text-sm text-neutral-500">Physical interfaces and software tools.</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                <div class="grid md:grid-cols-2 gap-4">
                                    <div class="bg-neutral-50 border border-neutral-200/80 p-4 rounded-xl">
                                        <h4 class="text-neutral-800 font-semibold mb-2">Mobile (BimmerCode/Link)</h4>
                                        <p class="text-sm text-neutral-500 mb-3">For light coding and battery reg.</p>
                                        <ul class="text-sm text-neutral-600 space-y-2">
                                            <li><span class="font-semibold text-primary">Recommended:</span> MHD Universal (Black), UniCarScan.</li>
                                            <li><span class="font-semibold text-red-500">Avoid:</span> Cheap ELM327 clones.</li>
                                        </ul>
                                    </div>
                                    <div class="bg-neutral-50 border border-neutral-200/80 p-4 rounded-xl">
                                        <h4 class="text-neutral-800 font-semibold mb-2">PC (ISTA+/E-Sys)</h4>
                                        <p class="text-sm text-neutral-500 mb-3">For heavy diagnostics and flashing.</p>
                                        <ul class="text-sm text-neutral-600 space-y-2">
                                            <li><strong><span class="text-primary">Cable:</span></strong> E-NET Cable (Ethernet to OBD).</li>
                                            <li><strong><span class="text-primary">Software:</span></strong> BimmerUtility is recommended for FDL coding.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- CODING LIBRARY (SPLIT STANDARD VS EXPERT) -->
                        <details id="part-2" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-accent-light p-3 rounded-lg text-accent"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">2. BimmerCode Library</h3><p class="text-sm text-neutral-500">Divided into Normal & Expert Modes.</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                
                                <!-- TABS -->
                                <div class="flex gap-2 mb-6 border-b border-neutral-200">
                                    <button class="tab-btn px-4 py-2 text-sm font-semibold rounded-t-lg bg-neutral-100 text-neutral-600 hover:bg-neutral-200 active" onclick="switchTab(this, 'tab-standard')">Standard Mode (Easy)</button>
                                    <button class="tab-btn px-4 py-2 text-sm font-semibold rounded-t-lg bg-neutral-100 text-neutral-600 hover:bg-neutral-200" onclick="switchTab(this, 'tab-expert')">Expert Mode (Advanced)</button>
                                </div>

                                <!-- TAB: STANDARD -->
                                <div id="tab-standard" class="tab-content space-y-6">
                                    <p class="text-sm text-neutral-600 bg-green-50 border border-green-100 p-3 rounded-lg">These features are available as simple toggles/menus in BimmerCode without entering Expert Mode.</p>
                                    
                                    <!-- BDC Standard -->
                                    <div>
                                        <h4 class="text-primary font-bold mb-3 text-sm">BDC (Body Domain Controller)</h4>
                                        <table class="w-full code-table">
                                            <thead><tr><th>Feature</th><th>Details</th></tr></thead>
                                            <tbody>
                                                <tr><td><strong>5-Blink Turn Signal</strong></td><td>Increases one-touch signal from 3 to 5.</td></tr>
                                                <tr><td><strong>Window Roll-up Interruption</strong></td><td>Allows window to keep closing even if door is opened.</td></tr>
                                                <tr><td><strong>Horn on Lock (Engine On)</strong></td><td>Disables the double honk when locking with engine running.</td></tr>
                                                <tr><td><strong>Rear DRLs</strong></td><td>Activates rear tail lights together with front DRLs.</td></tr>
                                                <tr><td><strong>Mirror Tilt in Reverse</strong></td><td>Adjust percentage (default is 70%, change to 50% or less).</td></tr>
                                                <tr><td><strong>Boot Opening Delay</strong></td><td>Set to 0.5s or 1s to prevent accidental opening.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- HU_MGU Standard -->
                                    <div>
                                        <h4 class="text-primary font-bold mb-3 text-sm">HU_MGU (Headunit)</h4>
                                        <table class="w-full code-table">
                                            <thead><tr><th>Feature</th><th>Details</th></tr></thead>
                                            <tbody>
                                                <tr><td><strong>Bowers & Wilkins Profile</strong></td><td>Unlocks B&W sound settings (concert hall, etc.) for HK systems.</td></tr>
                                                <tr><td><strong>Legal Disclaimers</strong></td><td>Disables startup safety warnings/camera warnings.</td></tr>
                                                <tr><td><strong>Video in Motion</strong></td><td>Allows video playback while driving (requires restart).</td></tr>
                                                <tr><td><strong>M Startup Animation</strong></td><td>Changes iDrive boot logo to M.</td></tr>
                                                <tr><td><strong>Tire Pressure & Temp</strong></td><td>Displays tire temp alongside pressure.</td></tr>
                                                <tr><td><strong>Checkbox Front DRL</strong></td><td>Adds option in iDrive to toggle front DRLs.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- ACSM / HKFM Standard -->
                                    <div>
                                        <h4 class="text-primary font-bold mb-3 text-sm">Other Modules</h4>
                                        <ul class="text-sm text-neutral-600 space-y-2">
                                            <li class="flex justify-between border-b border-neutral-100 pb-1"><span><strong>ACSM:</strong> Seatbelt Chimes</span> <span>Disable Driver/Passenger chimes independently.</span></li>
                                            <li class="flex justify-between border-b border-neutral-100 pb-1"><span><strong>HKFM:</strong> Tailgate Close</span> <span>Enable closing with Key Fob & Interior Button without long press.</span></li>
                                            <li class="flex justify-between border-b border-neutral-100 pb-1"><span><strong>DME:</strong> A/C Memory</span> <span>Remember last A/C setting (Off/On) after restart.</span></li>
                                            <li class="flex justify-between border-b border-neutral-100 pb-1"><span><strong>DKOMBI:</strong> Alpina Layout</span> <span>Change cluster to Alpina blue theme.</span></li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- TAB: EXPERT -->
                                <div id="tab-expert" class="tab-content hidden space-y-8">
                                    <div class="bg-red-50 text-red-700 text-sm p-4 rounded-lg border border-red-200">
                                        <strong>EXPERT MODE WARNING:</strong> Requires editing raw HEX/Binary values. One wrong value can cause malfunctions. Always backup before coding.
                                    </div>

                                    <!-- Sport Plus / Comfort Plus -->
                                    <div>
                                        <h4 class="text-neutral-800 font-bold text-sm mb-2">1. Sport+ & Comfort+ Activation</h4>
                                        <p class="text-xs text-neutral-500 mb-3">Enables hidden driving modes. Requires coding in 3 modules.</p>
                                        <div class="overflow-x-auto border border-neutral-200 rounded-lg">
                                            <table class="w-full code-table">
                                                <thead><tr><th>Module</th><th>Section / Group</th><th>Function</th><th>Value</th></tr></thead>
                                                <tbody>
                                                    <tr><td><strong>BDC</strong></td><td>3221 PfFesMaster</td><td><code>FesSportWorldMode1</code></td><td><code>SportExpert</code> (0x02)</td></tr>
                                                    <tr><td><strong>BDC</strong></td><td>3221 PfFesMaster</td><td><code>FesComfortWorldMode1</code></td><td><code>ComfortPlus</code> (0x05)</td></tr>
                                                    <tr><td><strong>HU_MGU</strong></td><td>3008 FES</td><td><code>FES_SPORT_EXPERT</code></td><td><code>aktiv</code></td></tr>
                                                    <tr><td><strong>HU_MGU</strong></td><td>3008 FES</td><td><code>FES_COMFORT_PLUS</code></td><td><code>aktiv</code></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Auto Steering Heat -->
                                    <div>
                                        <h4 class="text-neutral-800 font-bold text-sm mb-2">2. Auto Steering Wheel Heat Menu</h4>
                                        <p class="text-xs text-neutral-500 mb-3">Adds menu to auto-activate heat below specific temp.</p>
                                        <div class="overflow-x-auto border border-neutral-200 rounded-lg">
                                            <table class="w-full code-table">
                                                <thead><tr><th>Module</th><th>Section / Group</th><th>Function</th><th>Value</th></tr></thead>
                                                <tbody>
                                                    <tr><td><strong>HU_MGU</strong></td><td>3000 HMI_SPEECH</td><td><code>AKT_Auto_Lenkradheizung</code></td><td><code>aktiv</code></td></tr>
                                                    <tr><td><strong>BDC</strong></td><td>3142 PfLinLRE</td><td><code>LHZ_CCM_IKF</code></td><td><code>aktiv</code></td></tr>
                                                    <tr><td><strong>BDC</strong></td><td>3450 Others 1</td><td><code>IKF_ENABLE</code></td><td><code>ikf_alle_sitze</code></td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Misc Expert -->
                                    <div>
                                        <h4 class="text-neutral-800 font-bold text-sm mb-2">3. Miscellaneous Expert Coding</h4>
                                        <div class="space-y-3">
                                            <div class="bg-neutral-50 p-3 rounded border border-neutral-200">
                                                <h6 class="text-xs font-bold text-primary">Rear Camera Zoom (Towbar View)</h6>
                                                <p class="text-xs text-neutral-600">Module: <strong>HU_MGU</strong> > 300B Parken <br> Function: <code>Macro_trailer_coupling</code> > <code>aktiv</code></p>
                                            </div>
                                            <div class="bg-neutral-50 p-3 rounded border border-neutral-200">
                                                <h6 class="text-xs font-bold text-primary">Wireless Charging (Menu activation)</h6>
                                                <p class="text-xs text-neutral-600">Module: <strong>BDC</strong> > WcaWirelessChargingAblage > <code>WCA_ENABLE</code> > <code>aktiv</code><br>Module: <strong>HU_MGU</strong> > 3000 HMI_SPEECH > <code>WCA</code> > <code>aktiv</code></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- BIMMERUTILITY (DEEP DIVE) -->
                        <details id="part-8" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-orange-100 p-3 rounded-lg text-orange-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">3. BimmerUtility (Engineering)</h3><p class="text-sm text-neutral-500">Capabilities beyond BimmerCode.</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                <p class="text-sm text-neutral-600 mb-4">BimmerUtility is a professional-grade tool that replaces E-Sys Launchers. It allows access to modules that are <strong>locked or invisible</strong> in BimmerCode.</p>
                                
                                <div class="grid md:grid-cols-2 gap-4 mb-6">
                                    <div class="border border-neutral-200 p-4 rounded-xl">
                                        <h5 class="text-sm font-bold text-neutral-800 mb-2">Exclusive Capabilities</h5>
                                        <ul class="text-xs text-neutral-600 space-y-2">
                                            <li class="flex items-start gap-2"><span class="text-primary">●</span> <span><strong>SAS3 Module Access:</strong> Required for coding Lane Change Assistant and other ADAS features (BimmerCode cannot access this).</span></li>
                                            <li class="flex items-start gap-2"><span class="text-primary">●</span> <span><strong>VO Coding (FA Editor):</strong> Easily add/remove option codes (e.g., 2TB Sport Trans, 5DN Parking Plus) and code the whole car to match.</span></li>
                                            <li class="flex items-start gap-2"><span class="text-primary">●</span> <span><strong>CAFD Compare:</strong> Compare your coding files against stock or other cars to find differences.</span></li>
                                        </ul>
                                    </div>
                                    <div class="border border-neutral-200 p-4 rounded-xl">
                                        <h5 class="text-sm font-bold text-neutral-800 mb-2">Top BimmerUtility Codes</h5>
                                        <ul class="text-xs text-neutral-600 space-y-2">
                                            <li><strong>Enable Lane Change Assist:</strong> Requires coding HU_MGU, BDC, and <u>SAS3</u>.</li>
                                            <li><strong>Anti-Dazzle High Beams (US):</strong> Requires VO Coding to remove "5AP" (Decoding Anti-Dazzle) and then FDL coding KAFAS/FLM modules.</li>
                                            <li><strong>Variable Light Distribution:</strong> Requires VO coding to remove "8S4".</li>
                                        </ul>
                                    </div>
                                </div>

                                <!-- SPORT TRANSMISSION FAQ -->
                                <div class="border-t border-neutral-200 pt-4">
                                    <h5 class="text-sm font-bold text-neutral-800 flex items-center gap-2 mb-3">EGS (Transmission) - Sport Auto (2TB) <span class="bg-neutral-200 text-[10px] px-1.5 py-0.5 rounded text-neutral-600">VO Coding Guide</span></h5>
                                    
                                    <div class="space-y-3 mb-4">
                                        <div class="bg-neutral-50 p-3 rounded-lg border border-neutral-200">
                                            <h6 class="text-xs font-bold text-neutral-700">1. Difference vs. Standard (205)</h6>
                                            <p class="text-xs text-neutral-600 mt-1">Option 2TB provides noticeably snappier shifts in Sport/Sport+ modes and holds gears longer. Shifts feel firmer (less torque smoothing).</p>
                                        </div>
                                        <div class="bg-neutral-50 p-3 rounded-lg border border-neutral-200">
                                            <h6 class="text-xs font-bold text-neutral-700">2. Are Paddle Shifters Required?</h6>
                                            <p class="text-xs text-neutral-600 mt-1"><strong>No.</strong> You can code 2TB without paddles. The transmission will behave aggressively as intended. <em class="text-neutral-400">(Note: A harmless "missing paddles" shadow error may appear in diagnostics, but it does not affect functionality).</em></p>
                                        </div>
                                        <div class="bg-neutral-50 p-3 rounded-lg border border-neutral-200">
                                            <h6 class="text-xs font-bold text-neutral-700">3. How to Activate Launch Control</h6>
                                            <p class="text-xs text-neutral-600 mt-1">Coding 2TB automatically enables Launch Control logic in the EGS.</p>
                                            <ol class="list-decimal list-inside text-xs text-neutral-600 mt-1 space-y-1 pl-1">
                                                <li>Drive 10km to warm up engine/transmission.</li>
                                                <li>Select <strong>Sport+</strong> (or DTC/Traction mode).</li>
                                                <li>Move shifter left to <strong>S/M</strong> gate.</li>
                                                <li>Press Brake <strong>hard</strong> with left foot.</li>
                                                <li>Floor Gas past the resistance point (kickdown). "Launch Control Active" flag appears on dash.</li>
                                                <li>Release Brake within 3 seconds.</li>
                                            </ol>
                                        </div>
                                    </div>

                                    <div class="bg-primary/5 border border-primary/20 p-3 rounded-lg">
                                        <p class="text-xs text-primary-dark mb-1 font-bold">Step-by-Step Coding (BimmerUtility):</p>
                                        <ol class="list-decimal list-inside text-xs text-neutral-700 space-y-1">
                                            <li>Connect BimmerUtility and go to <strong>Vehicle Order (FA)</strong>.</li>
                                            <li>In the "SALAPA-Elements" list, type <code>2TB</code> and click Add.</li>
                                            <li>Click <strong>Save</strong> to update the FA.</li>
                                            <li>Go to the <strong>Coding</strong> (ECU List) tab.</li>
                                            <li>Right-click the <strong>EGS</strong> (Transmission) module and select <strong>Code</strong> (This VO Codes the module).</li>
                                            <li>(Optional) Code BDC and DKOMBI if you want Sport+ menu items to appear correctly.</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- E-SYS CODING (NEW SECTION) -->
                        <details id="part-esys" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-blue-100 p-3 rounded-lg text-blue-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">4. E-Sys Coding (Advanced Flashing)</h3><p class="text-sm text-neutral-500">Firmware Flashing & Updates.</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
                                    <h4 class="text-red-800 font-bold flex items-center gap-2 mb-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg> High Risk Procedure</h4>
                                    <p class="text-sm text-red-700">This process involves <strong>flashing firmware</strong> to the transmission ECU. A voltage drop <strong>WILL brick</strong> the module. A <strong>50A+ Power Supply Unit (PSU)</strong> connected to the battery is mandatory. Do not use a battery charger.</p>
                                </div>

                                <!-- PROJECT 1: ALPINA (EXPANDED & EXPLAINED) -->
                                <div class="mb-8">
                                    <h4 class="text-lg font-bold text-neutral-800 mb-2">Project A: Enable ALPINA Transmission Software</h4>
                                    <p class="text-sm text-neutral-600 mb-4">Compatible with F/G-Series BMWs using ZF 8HP transmissions (typically 3.0L+ engines). This flash replaces the standard BMW shift logic with ALPINA's mapped logic, offering buttery smooth shifts in Comfort (displaying gear numbers D1, D2) and rapid, torque-heavy shifts in Sport.</p>

                                    <div class="space-y-6">
                                        
                                        <!-- Step 1 -->
                                        <div class="bg-neutral-50 p-4 rounded-xl border border-neutral-200">
                                            <h5 class="font-bold text-sm text-neutral-800 mb-2">1. Preparation & Requirements</h5>
                                            <ul class="list-disc list-inside text-xs text-neutral-600 space-y-1">
                                                <li><strong>Power Supply:</strong> You must maintain 13.0V+. If voltage drops during the bootloader erase phase, the ECU will remain in a boot loop (bricked).</li>
                                                <li><strong>Software:</strong> E-Sys (e.g., 3.27 or 3.30+) with <strong>Full PSdZData</strong>. The "Full" version contains the actual firmware files (swe, swfl) needed for flashing. "Lite" only contains coding data.</li>
                                                <li><strong>Connection:</strong> Ensure a stable ENET connection. Disable laptop sleep/screensaver.</li>
                                            </ul>
                                        </div>

                                        <!-- Step 2 -->
                                        <div class="border-l-4 border-primary pl-4">
                                            <h5 class="font-bold text-neutral-800 text-sm mb-1">2. Edit Vehicle Order (FA) - The "Spoof"</h5>
                                            <p class="text-xs text-neutral-500 mb-2">To get E-Sys to calculate the ALPINA firmware, we must temporarily trick the software into thinking your car <em>is</em> an ALPINA model.</p>
                                            <ol class="list-decimal list-inside text-xs text-neutral-600 space-y-2">
                                                <li>Go to <strong>Expert Mode > Coding</strong>. Read your FA (Vehicle Order) and <strong>Save</strong> it as <code>ALPINA_FA.xml</code>.</li>
                                                <li>Open <strong>Editors > FA Editor</strong> and load your new file.</li>
                                                <li><strong>Add Option Codes:</strong> Navigate to <code>SALAPA-Element</code>. Add:
                                                    <ul class="ml-4 mt-1 mb-1 text-primary-dark">
                                                        <li><code>920</code> (Alpina without label)</li>
                                                        <li><code>9XA</code> (Alpina package)</li>
                                                    </ul>
                                                </li>
                                                <li><strong>Change Type Code (Typschlüssel):</strong> This is the most critical step. You must change your chassis code to the ALPINA equivalent.
                                                    <div class="mt-2 bg-neutral-100 p-2 rounded border border-neutral-200">
                                                        <strong>Examples (Verify on forums for your specific engine):</strong>
                                                        <ul class="ml-2 mt-1">
                                                            <li>G30 530d (JC91) &rarr; <strong>JD11</strong> (Alpina D5 S)</li>
                                                            <li>F10 535d (5D51) &rarr; <strong>5E51</strong></li>
                                                            <li>F30 335d &rarr; Research "Alpina D3 Biturbo" type code.</li>
                                                        </ul>
                                                    </div>
                                                </li>
                                                <li><strong>Time Criteria (Zeitkriterium):</strong> If your car is older than the first ALPINA of that model, update the date (e.g., from 0711 to 1211) so the software exists.</li>
                                                <li>Right-click FA &rarr; <strong>Calculate FP</strong>. If it calculates without error, the Type Code is valid. Save.</li>
                                            </ol>
                                        </div>

                                        <!-- Step 3 -->
                                        <div class="border-l-4 border-primary pl-4">
                                            <h5 class="font-bold text-neutral-800 text-sm mb-1">3. Calculate Firmware (TAL)</h5>
                                            <p class="text-xs text-neutral-500 mb-2">We now ask E-Sys: "If this car were an ALPINA (based on the FA we just made), what software should it have?"</p>
                                            <ol class="list-decimal list-inside text-xs text-neutral-600 space-y-2">
                                                <li>Go to <strong>Comfort Mode > TAL Calculating</strong>.</li>
                                                <li>Load your modified <code>ALPINA_FA.xml</code>.</li>
                                                <li><strong>Read SVT</strong> (This reads the current state of your ECUs).</li>
                                                <li><strong>SVT Target:</strong> Select "Complete Flash".</li>
                                                <li><strong>I-Step (Shipm.):</strong> Select the I-Level matching your car's production date.</li>
                                                <li><strong>I-Step (Target):</strong> Select the latest available version in your PSdZData.</li>
                                                <li>Click <strong>Calculate</strong>.</li>
                                                <li><strong>Verify the Result:</strong> Look at the <strong>EGS</strong> (Transmission) folder in the generated tree. It should show blue/red changes indicating a new firmware file (SWFL) is planned. Common ALPINA SWFL IDs: <code>47DA</code> (G-Series), <code>1367</code> (F-Series).</li>
                                                <li>Save the generated <code>SVT_soll</code> (Target) and <code>TAL</code> (Transaction Action List) files.</li>
                                            </ol>
                                        </div>

                                        <!-- Step 4 -->
                                        <div class="border-l-4 border-red-500 pl-4">
                                            <h5 class="font-bold text-neutral-800 text-sm mb-1">4. Flash Process (Critical Execution)</h5>
                                            <p class="text-xs text-neutral-500 mb-2">This is where we write the data. <strong class="text-red-600">One mistake here can brick other modules.</strong></p>
                                            <ol class="list-decimal list-inside text-xs text-neutral-600 space-y-2">
                                                <li>Go to <strong>Expert Mode > TAL Processing</strong>.</li>
                                                <li>Load your <code>TAL</code>, <code>SVT_soll</code>, and the modified <code>ALPINA_FA</code>.</li>
                                                <li><strong>UNCHECK EVERYTHING:</strong> The list will show all ECUs. You MUST uncheck every single box (blFlash, swDeploy, etc.) for every ECU <strong>EXCEPT the EGS</strong>.
                                                    <br><em class="text-xs text-red-600">Reason: If you leave the DME (Engine) checked, E-Sys will try to flash ALPINA engine software onto your standard engine, which will fail and brick the DME.</em>
                                                </li>
                                                <li><strong>Select EGS Only:</strong> For the EGS row, check:
                                                    <ul class="ml-4 mt-1 text-primary-dark font-mono">
                                                        <li>blFlash (Bootloader)</li>
                                                        <li>swDeploy (Software)</li>
                                                        <li>cdDeploy (Coding Data)</li>
                                                        <li>ibaDeploy (Manuals)</li>
                                                    </ul>
                                                </li>
                                                <li>Click <strong>Check Software Availability</strong>. It ensures the files exist in your library.</li>
                                                <li><strong>Start:</strong> Press Start. The transmission will disconnect, gears will vanish from dash. Process takes ~2 minutes. Success message will appear.</li>
                                            </ol>
                                        </div>

                                        <!-- Step 5 -->
                                        <div class="bg-green-50 p-4 rounded-xl border border-green-200">
                                            <h5 class="font-bold text-sm text-green-800 mb-1">5. Verification & Cleanup</h5>
                                            <ul class="list-disc list-inside text-xs text-green-700 space-y-1">
                                                <li><strong>Hard Reset:</strong> Disconnect E-Sys. Turn off ignition. Lock car. Wait 5-10 minutes for the car to sleep (modules reboot).</li>
                                                <li><strong>Verify:</strong> Start engine. In <strong>Comfort Mode</strong>, the cluster should display <strong>D1, D2, D3</strong> instead of just "D".</li>
                                                <li><strong>Clear Errors:</strong> Your car will likely have "Drivetrain Malfunction" errors initially due to lost communication during flash. Use ISTA+ or BimmerLink to clear all error codes.</li>
                                                <li><strong>Enjoy:</strong> Test drive to adapt the new shift points.</li>
                                            </ul>
                                        </div>

                                    </div>
                                </div>

                                <!-- PROJECT 2: I-STEP UPDATE -->
                                <div>
                                    <h4 class="text-lg font-bold text-neutral-800 mb-4">Project B: Full I-Step Software Update</h4>
                                    <p class="text-sm text-neutral-600 mb-4">Updating the entire vehicle's firmware to the latest version (I-Level). Fixes bugs, improves logic.</p>

                                    <div class="space-y-4">
                                        <div class="bg-neutral-50 p-4 rounded-lg border border-neutral-200">
                                            <h5 class="font-bold text-sm text-neutral-800 mb-2">Pre-Flash Checklist</h5>
                                            <ul class="list-disc list-inside text-xs text-neutral-600 space-y-1">
                                                <li><strong>Power:</strong> Connect 50A+ PSU. Open hood (diagnostic mode) and trunk (battery access).</li>
                                                <li><strong>Software:</strong> Use plain E-Sys (e.g., 3.36) without launchers. Full PSdZData required.</li>
                                                <li><strong>Test:</strong> Code a safe ECU (e.g., Climate) first to verify stable connection.</li>
                                            </ul>
                                        </div>

                                        <div class="border-l-4 border-blue-500 pl-4 space-y-3">
                                            <div>
                                                <h5 class="font-bold text-neutral-800 text-sm">1. Calculate Targets (Comfort Mode)</h5>
                                                <ol class="list-decimal list-inside text-xs text-neutral-600 space-y-1">
                                                    <li>Read <strong>FA</strong> (Vehicle Order) & <strong>SVT Actual</strong> (Current ECUs). Save both.</li>
                                                    <li>Go to <strong>TAL Calculating</strong>. Load FA & SVT Actual.</li>
                                                    <li>Set Calculation Strategy: <strong>Complete Flash</strong>.</li>
                                                    <li>Select <strong>I-Step (Shipm.)</strong> (Auto-detected) and <strong>I-Step (Target)</strong> (Newest available).</li>
                                                    <li>Click <strong>Calculate</strong>. Save <code>SVT_soll</code> (Target) and <code>TAL</code> (Transaction List).</li>
                                                    <li><em>Review:</em> Check SVT tree. Black HW (Hardware) = Good. Blue/Red HW = Mismatch (Stop!).</li>
                                                </ol>
                                            </div>
                                            <div>
                                                <h5 class="font-bold text-neutral-800 text-sm">2. Execute Flash (Expert Mode)</h5>
                                                <ol class="list-decimal list-inside text-xs text-neutral-600 space-y-1">
                                                    <li>Go to <strong>TAL Processing</strong>. Load TAL, SVT Target, and FA.</li>
                                                    <li><strong>Parameters:</strong> Check <code>blFlash</code>, <code>swDeploy</code>, <code>cdDeploy</code>, <code>ibaDeploy</code>. Leave <code>Parallel Programming</code> ON.</li>
                                                    <li><strong>Start:</strong> Press Start. The process can take 60-90 minutes.</li>
                                                </ol>
                                            </div>
                                            <div>
                                                <h5 class="font-bold text-neutral-800 text-sm">3. Post-Flash</h5>
                                                <ul class="list-disc list-inside text-xs text-neutral-600 space-y-1">
                                                    <li><strong>Update VCM:</strong> Go to VCM > Master. Write the new I-Step to the car.</li>
                                                    <li><strong>Clear Errors:</strong> Use external transmitter or ISTA+ to clear the hundreds of temporary errors generated.</li>
                                                    <li><strong>Lock Airbags:</strong> If ACSM was flashed, use ISTA+ Service Functions to lock airbags.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <!-- SERVICE HISTORY (NEW SECTION) -->
                        <details id="part-service" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-green-100 p-3 rounded-lg text-green-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">5. Service History & Maintenance</h3><p class="text-sm text-neutral-500">Digital Service Records (iDrive).</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                <p class="text-sm text-neutral-600 mb-4">If you perform your own maintenance, you can write the digital records to the iDrive screen using third-party tools.</p>

                                <div class="grid md:grid-cols-2 gap-4 mb-6">
                                    <div class="bg-neutral-50 p-4 rounded-xl border border-neutral-200">
                                        <h5 class="font-bold text-sm text-neutral-800 mb-2">Tools Required</h5>
                                        <ul class="text-xs text-neutral-600 space-y-1">
                                            <li><strong>Hardware:</strong> ENET Cable.</li>
                                            <li><strong>Software:</strong> HU Service Manager (older) or <strong>Service History Manager (SHM)</strong> (Preferred/Easier).</li>
                                            <li><strong>Dependencies:</strong> Ediabas must be installed. Use "EasyConnect" tool to lock ENET IP.</li>
                                        </ul>
                                    </div>
                                    <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                        <h5 class="font-bold text-sm text-yellow-800 mb-2">Important Note</h5>
                                        <p class="text-xs text-yellow-700">These records are stored <strong>locally</strong> in the Headunit. They are NOT uploaded to BMW's central servers. If a dealer updates your software or connects their tools, these local records may be overwritten by the official server data.</p>
                                    </div>
                                </div>

                                <div class="border-l-4 border-green-500 pl-4">
                                    <h5 class="font-bold text-neutral-800 text-sm">Procedure (Using SHM)</h5>
                                    <ol class="list-decimal list-inside text-xs text-neutral-600 mt-2 space-y-2">
                                        <li><strong>Connect:</strong> Plug in ENET cable. Use "EasyConnect" to set Mode to ENET and Lock IP.</li>
                                        <li><strong>Launch:</strong> Open Service History Manager (SHM).</li>
                                        <li><strong>Read (Optional):</strong> If you have the Pro version, click "Read from Car". Otherwise, take a photo of your existing history screen as a backup.</li>
                                        <li><strong>Add Entry:</strong> Click "Add".
                                            <ul class="ml-4 mt-1 space-y-1 list-disc">
                                                <li><strong>Date:</strong> Select service date.</li>
                                                <li><strong>Mileage:</strong> Enter km at time of service.</li>
                                                <li><strong>Dealer:</strong> Enter a code or text (e.g., "007" or "DIY").</li>
                                                <li><strong>Job:</strong> Check boxes for Oil, Microfilter, Brake Fluid, etc.</li>
                                            </ul>
                                        </li>
                                        <li><strong>Write:</strong> Click "Write to Car". The Headunit will restart automatically.</li>
                                        <li><strong>Verify:</strong> Check iDrive > Vehicle Status > Service Requirements > Service History.</li>
                                    </ol>
                                </div>
                            </div>
                        </details>

                        <!-- DIAGNOSTICS -->
                        <details id="part-6" class="group bg-white border border-neutral-200 rounded-2xl overflow-hidden transition-all hover:border-primary/50 shadow-sm">
                            <summary class="flex justify-between items-center p-5 cursor-pointer select-none hover:bg-neutral-50 transition-colors">
                                <div class="flex items-center gap-4">
                                    <div class="bg-purple-100 p-3 rounded-lg text-purple-600"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></div>
                                    <div><h3 class="text-lg font-semibold text-neutral-900">6. Diagnostics (ISTA+)</h3><p class="text-sm text-neutral-500">Dealer-level troubleshooting.</p></div>
                                </div>
                                <svg class="chevron w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </summary>
                            <div class="px-5 pb-5 border-t border-neutral-200/80 pt-4">
                                <p class="text-sm text-neutral-600 mb-4">ISTA+ is BMW's official diagnostic software. It doesn't just read codes; it tells you how to fix them.</p>
                                <div class="border-l-4 border-primary pl-4 bg-neutral-50 p-3 rounded-r-lg">
                                    <h5 class="text-neutral-800 font-semibold text-sm">Correct Workflow:</h5>
                                    <ol class="list-decimal list-inside text-sm text-neutral-600 mt-1 space-y-1">
                                        <li>Connect via E-NET and run "Complete Identification".</li>
                                        <li>Go to "Fault Memory", select a fault, and click <strong>"Calculate Test Plan"</strong>.</li>
                                        <li>Follow the ABL (Procedure) step-by-step.</li>
                                    </ol>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </main>
        </div>

        <!-- PANEL 2: THE CHAT (Hidden by Default) -->
        <div id="chat-panel" class="fixed inset-0 z-[60] bg-neutral-100 flex flex-col">
            <div class="flex items-center justify-between p-3 border-b border-neutral-200 bg-white/80 backdrop-blur-md shadow-sm z-20">
                <div class="flex items-center gap-3">
                    <button id="close-chat-btn" class="p-2 hover:bg-neutral-200 rounded-full text-neutral-600 hover:text-neutral-900 transition-colors" title="Close Assistant"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                    <div>
                        <h3 class="text-neutral-900 font-semibold">Bimmerni</h3>
                        <div id="connection-status" class="flex items-center gap-2"></div>
                    </div>
                </div>
                <button id="clear-chat-btn" class="text-xs text-neutral-500 hover:text-red-500 transition-colors font-medium">Clear History</button>
            </div>
            
            <!-- Chat Log -->
            <div id="chat-log" class="flex-1 p-4 space-y-6 overflow-y-auto"></div>
            
            <!-- Chat Input -->
            <div class="p-4 border-t border-neutral-200 bg-white/90 z-20 pb-[env(safe-area-inset-bottom)]">
                <form id="chat-form" class="relative max-w-4xl mx-auto flex gap-3">
                    <input type="text" id="chat-input" placeholder="Ask about 'Sport+' or 'Lane Assist'..." class="flex-1 bg-neutral-100 text-neutral-800 placeholder-neutral-500 border border-neutral-300 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all shadow-inner w-full" autocomplete="off">
                    <button type="submit" id="chat-submit-btn" class="bg-primary hover:bg-primary-dark text-white p-3 rounded-xl transition-colors shadow-lg shadow-primary/20 disabled:opacity-50 disabled:cursor-not-allowed"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg></button>
                </form>
                <p class="text-center text-xs text-neutral-500 mt-2">AI can make mistakes. Verify critical information. Use Metric units.</p>
            </div>
        </div>
    </div>

    <!-- FAB and MODALS -->
    <!-- Simplified positioning classes to fix mobile visibility issues -->
    <button id="open-chat-btn" class="fixed right-6 bottom-6 bg-primary hover:bg-primary-dark text-white px-6 py-3.5 rounded-full shadow-xl shadow-primary/30 transition-all hover:scale-105 hover:shadow-2xl flex items-center gap-3 group active:scale-95">
        <span class="font-bold text-sm tracking-wide">Ask Bimmerni</span>
        <div class="bg-white/20 p-1 rounded-full group-hover:bg-white/30 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
        </div>
    </button>
    
    <!-- Wizard Modal -->
    <div id="wizard-modal" class="fixed inset-0 z-[100] bg-black/70 backdrop-blur-md flex items-center justify-center p-4">
        <div id="wizard-content" class="bg-white border border-neutral-200 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-neutral-200">
                <div>
                    <h3 class="text-lg font-bold text-neutral-900">Step-by-Step Guide</h3>
                    <p id="wizard-step-counter" class="text-sm text-primary font-medium">Step 1 of X</p>
                </div>
                <button id="wizard-close-btn" class="text-neutral-500 hover:text-neutral-800 bg-neutral-100 hover:bg-neutral-200 p-2 rounded-lg transition-colors">&times;</button>
            </div>
            <div class="p-8 flex-1 overflow-y-auto flex items-center justify-center">
                <div id="wizard-step-text" class="text-lg md:text-xl text-center text-neutral-700 leading-relaxed font-medium"></div>
            </div>
            <div class="flex justify-between p-5 border-t border-neutral-200 bg-neutral-50/50 gap-3">
                <button id="wizard-help-btn" class="px-4 py-2.5 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-medium transition-colors text-sm">Troubleshoot / More Info</button>
                <div class="flex gap-2">
                    <button id="wizard-nav-back" class="px-6 py-2.5 bg-neutral-200 hover:bg-neutral-300 text-neutral-800 rounded-xl font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                    <button id="wizard-nav-next" class="px-6 py-2.5 bg-primary hover:bg-primary-dark text-white rounded-xl font-medium transition-colors">Next Step</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Credential Manager: Securely handles obfuscated API credentials
        // Note: Client-side obfuscation is not a replacement for server-side security.
        class CredentialManager {
            constructor() {
                this._0x = [
                    '41497a615379', // Chunk 1 (AIzaSy)
                    '446861633630', // Chunk 2 (Dhac60)
                    '5a5931633451', // Chunk 3 (ZY1c4Q)
                    '4441794a6c4c', // Chunk 4 (DAyJlL)
                    '74526b503958', // Chunk 5 (tRkP9X)
                    '795244394b57', // Chunk 6 (yRD9KW)
                    '666f30'        // Chunk 7 (fo0)
                ];
            }
            
            // Complex Reassembly Method
            _reassemble() {
                return this._0x.map(c => {
                    let str = '';
                    for (let i = 0; i < c.length; i += 2) {
                        str += String.fromCharCode(parseInt(c.substr(i, 2), 16));
                    }
                    return str;
                }).join('');
            }
            
            getKey() {
                return this._reassemble();
            }
        }

        const state = {
            apiKey: new CredentialManager().getKey(),
            chatHistory: JSON.parse(localStorage.getItem('chat_history') || '[]'),
            wizardSteps: [],
            currentStep: 0,
        };

        // Updated Prompt with Specific Knowledge from the BimmerCode Guide & 2TB Research & E-Sys Flashing & Service History
        const SYSTEM_PROMPT = `You are Bimmerni, an expert BMW software engineer for G-Chassis (G20/G80) vehicles. 
        
        Use these CONFIRMED Expert Mode values (Metric units):
        - **Sport+ Mode**:
            - BDC > 3221 PfFesMaster > FesSportWorldMode1 = SportExpert (0x02)
            - HU_MGU > 3008 FES > FES_SPORT_EXPERT = aktiv
        - **Comfort+ Mode**:
            - BDC > 3221 PfFesMaster > FesComfortWorldMode1 = ComfortPlus (0x05)
            - HU_MGU > 3008 FES > FES_COMFORT_PLUS = aktiv
        - **Auto Steering Heat**: 
            - HU_MGU > AKT_Auto_Lenkradheizung = aktiv
            - BDC > LHZ_CCM_IKF = aktiv AND IKF_ENABLE = ikf_alle_sitze
        - **Bowers & Wilkins**: HU_MGU > Audio System = alev4-Ram
        - **Wireless Charging**: BDC > WCA_ENABLE = aktiv AND HU_MGU > WCA = aktiv
        - **Rear Camera Zoom**: HU_MGU > Macro_trailer_coupling = aktiv
        - **Sport Trans (2TB)**: BimmerUtility required for VO coding (add 2TB). BimmerCode can't VO code.
        - **BimmerUtility vs BimmerCode**: BimmerUtility allows VO Coding, SAS3 access (Lane Assist), and CAFD comparison.
        - **ALPINA Transmission Flash (E-Sys)**: 
           1. Connect 50A PSU.
           2. Edit FA: Add 920 + 9XA options. Change Type Code to ALPINA model (e.g., JC91 -> JD11).
           3. Calculate TAL with new FA.
           4. Expert Mode > TAL Processing > Select ONLY EGS. Flash.
           5. Verify: "D1" displayed in Comfort mode.
        - **Full I-Step Update (E-Sys)**:
           1. Prereqs: 50A PSU, Plain E-Sys (no launcher), Full PSdZData.
           2. Comfort Mode > TAL Calculating: Read FA/SVT. Strategy: "Complete Flash". Select Shipment/Target I-Step. Calculate.
           3. Expert Mode > TAL Processing: Load TAL, SVT, FA. Select blFlash, swDeploy, cdDeploy, ibaDeploy. Start.
           4. Post: Write VCM I-Step, Clear Errors with ISTA.
        - **Service History Writing**:
           1. Tools: HU Service Manager or SHM. Ediabas + EasyConnect required.
           2. Note: Local write only. Overwritten if dealer updates car.
           3. Process: Connect > Add Record (Date/Km/Dealer/Job) > Write to Car > Restart HU.

        Always prioritize safety (50A PSU required for flashing). Be concise. Format with Markdown.`;

        const dom = {
            body: document.body,
            openChatBtn: document.getElementById('open-chat-btn'),
            closeChatBtn: document.getElementById('close-chat-btn'),
            // Removed Settings DOM elements as they are no longer needed
            chatLog: document.getElementById('chat-log'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            chatSubmitBtn: document.getElementById('chat-submit-btn'),
            clearChatBtn: document.getElementById('clear-chat-btn'),
            connectionStatus: document.getElementById('connection-status'),
            wizardModal: document.getElementById('wizard-modal'),
            wizardText: document.getElementById('wizard-step-text'),
            wizardCounter: document.getElementById('wizard-step-counter'),
            wizardNext: document.getElementById('wizard-nav-next'),
            wizardBack: document.getElementById('wizard-nav-back'),
            wizardHelp: document.getElementById('wizard-help-btn'),
            wizardClose: document.getElementById('wizard-close-btn'),
        };

        const ui = {
            openChat: () => { dom.body.classList.add('chat-open'); dom.chatInput.focus(); },
            closeChat: () => { dom.body.classList.remove('chat-open'); },
            updateConnectionStatus: () => {
                // Hardcoded success state for visual feedback
                dom.connectionStatus.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span class="text-xs text-neutral-500">Connected (Pro)</span>`;
            },
            // NAVIGATION LOGIC: Opens accordion and scrolls
            setupNavigation: () => {
                document.querySelectorAll('nav a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        const href = link.getAttribute('href');
                        if (!href.startsWith('#')) return;
                        e.preventDefault();
                        const target = document.querySelector(href);
                        if (target) {
                            if (target.tagName === 'DETAILS') target.open = true;
                            target.scrollIntoView({ behavior: 'smooth' });
                            target.classList.add('target-highlight');
                            setTimeout(() => target.classList.remove('target-highlight'), 1500);
                        }
                    });
                });
            }
        };

        // Tab Switcher for Coding Library
        window.switchTab = (btn, tabId) => {
            // Buttons
            const parent = btn.closest('.flex');
            parent.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'bg-primary', 'text-white');
                b.classList.add('bg-neutral-100', 'text-neutral-600');
            });
            btn.classList.add('active', 'bg-primary', 'text-white');
            btn.classList.remove('bg-neutral-100', 'text-neutral-600');

            // Content
            const contentParent = parent.nextElementSibling.parentElement;
            contentParent.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
        };
        
        const utils = {
             copyToClipboard: (id) => { 
                 const el = document.getElementById(id); 
                 if(el) navigator.clipboard.writeText(el.innerText); 
             }
        };

        const markdown = {
            parse: (text) => {
                if (!text) return '';
                let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
                    const id = 'code-' + Math.random().toString(36).substr(2, 9);
                    return `<div class="relative group"><button onclick="utils.copyToClipboard('${id}')" class="absolute top-2 right-2 bg-neutral-700/80 hover:bg-neutral-600 text-xs text-white px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">Copy</button><pre><code id="${id}">${code.trim()}</code></pre></div>`;
                });
                html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
                html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/^\s*[\-\*]\s+(.*)/gm, '<ul><li>$1</li></ul>');
                html = html.replace(/<\/ul>\s*<ul>/g, '');
                html = html.replace(/^\s*\d+\.\s+(.*)/gm, '<ol><li>$1</li></ol>');
                html = html.replace(/<\/ol>\s*<ol>/g, '');
                let parts = html.split(/(<\/?(?:ul|ol|li|pre)[^>]*>)/g);
                html = parts.map(part => {
                    if (part.match(/<\/?(?:ul|ol|li|pre)/)) return part;
                    return part.replace(/\n/g, '<br>');
                }).join('');
                return `<p>${html}</p>`;
            }
        };

        const wizard = {
            start: (messageId) => {
                const msgContainer = document.getElementById(messageId);
                if(!msgContainer) return;
                const steps = Array.from(msgContainer.querySelectorAll('li')).map(li => li.innerHTML);
                if(steps.length === 0) return;
                state.wizardSteps = steps;
                state.currentStep = 0;
                wizard.render();
                dom.wizardModal.classList.add('open');
            },
            render: () => {
                dom.wizardText.innerHTML = state.wizardSteps[state.currentStep];
                dom.wizardCounter.innerText = `Step ${state.currentStep + 1} of ${state.wizardSteps.length}`;
                dom.wizardBack.disabled = state.currentStep === 0;
                dom.wizardNext.innerText = (state.currentStep === state.wizardSteps.length - 1) ? 'Finish' : 'Next Step';
            },
            next: () => {
                if(state.currentStep < state.wizardSteps.length - 1) { state.currentStep++; wizard.render(); } 
                else { dom.wizardModal.classList.remove('open'); }
            },
            back: () => {
                if(state.currentStep > 0) { state.currentStep--; wizard.render(); }
            },
            askForHelp: () => {
                const stepText = state.wizardSteps[state.currentStep];
                dom.wizardModal.classList.remove('open');
                ui.openChat();
                const query = `I need help with step ${state.currentStep + 1}: "${stepText}". I encountered an error or need more details.`;
                dom.chatInput.value = query;
                // Automatically submit
                chat.handleSubmission({ preventDefault: () => {} });
            }
        };

        const chat = {
            init: () => {
                ui.updateConnectionStatus();
                if (state.chatHistory.length === 0) {
                    // Immediate welcome message, no key prompt needed
                    chat.addBotMessage("Hello! I'm Bimmerni. I'm ready to help with your coding, diagnostics, and retrofit questions.");
                } else {
                    state.chatHistory.forEach(msg => (msg.role === 'user') ? chat.renderUserMessage(msg.text) : chat.renderBotMessage(msg.text));
                }
            },
            handleSubmission: async (e) => {
                e.preventDefault();
                const text = dom.chatInput.value.trim();
                if (!text || dom.chatSubmitBtn.disabled) return;
                // Removed check for state.apiKey as it is hardcoded
                
                dom.chatSubmitBtn.disabled = true;
                dom.chatInput.value = '';
                chat.renderUserMessage(text);
                chat.saveMessage('user', text);
                
                await chat.fetchGemini(text);
                dom.chatSubmitBtn.disabled = false;
                setTimeout(() => dom.chatInput.focus(), 100);
            },
            saveMessage: (role, text) => {
                state.chatHistory.push({ role, text });
                localStorage.setItem('chat_history', JSON.stringify(state.chatHistory));
            },
            renderUserMessage: (text) => {
                const html = `<div class="flex justify-end animate-fadeIn"><div class="bg-primary text-white p-3 rounded-2xl rounded-tr-none max-w-[85%] shadow-md text-sm">${text}</div></div>`;
                dom.chatLog.insertAdjacentHTML('beforeend', html);
                chat.scrollToBottom();
            },
            renderBotMessage: (text, isTyping = false) => {
                const messageId = `msg-${Date.now()}`;
                const formatted = isTyping ? '' : markdown.parse(text);
                const hasSteps = formatted.includes('<li');
                const wizardBtn = hasSteps ? `<button onclick="wizard.start('${messageId}')" class="mt-3 flex items-center text-xs font-bold text-primary hover:text-primary-dark transition-colors bg-primary-light px-3 py-2 rounded-lg"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Start Step-by-Step Guide</button>` : '';

                const html = `<div class="flex justify-start animate-fadeIn" id="${messageId}"><div class="flex gap-3 max-w-[95%]"><div class="w-8 h-8 rounded-full bg-neutral-200 flex-shrink-0 flex items-center justify-center border border-neutral-300"><svg class="w-5 h-5 text-neutral-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div><div class="bg-white border border-neutral-200 text-neutral-800 p-4 rounded-2xl rounded-tl-none shadow-sm text-sm md-content overflow-hidden">${isTyping ? '<div class="flex gap-1.5 h-4 items-center"><span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce"></span><span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay:0.1s"></span><span class="w-2 h-2 bg-neutral-400 rounded-full animate-bounce" style="animation-delay:0.2s"></span></div>' : formatted + wizardBtn}</div></div></div>`;
                dom.chatLog.insertAdjacentHTML('beforeend', html);
                chat.scrollToBottom();
                return messageId;
            },
            addBotMessage: (text) => {
                chat.renderBotMessage(text);
                chat.saveMessage('bot', text);
            },
            scrollToBottom: () => {
                dom.chatLog.scrollTop = dom.chatLog.scrollHeight;
            },
            fetchGemini: async (prompt) => {
                const loadingId = chat.renderBotMessage("", true);
                const loadingEl = document.getElementById(loadingId);
                try {
                    // Using gemini-2.5-flash-preview-09-2025
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }], 
                            systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] } 
                        })
                    });
                    
                    if (!response.ok) { 
                        const errorData = await response.json(); 
                        throw new Error(errorData.error.message || 'API Error'); 
                    }
                    
                    const data = await response.json();
                    const answer = data.candidates[0].content.parts[0].text;
                    loadingEl?.remove();
                    chat.addBotMessage(answer);
                } catch (err) {
                    loadingEl?.remove();
                    chat.renderBotMessage(`Error: Could not connect to the AI. Please check your connection. <br><code class="text-xs text-red-500">${err.message}</code>`);
                }
            }
        };

        // Event Listeners
        dom.openChatBtn.addEventListener('click', ui.openChat);
        dom.closeChatBtn.addEventListener('click', ui.closeChat);
        // Removed Settings event listeners
        dom.chatForm.addEventListener('submit', chat.handleSubmission);
        dom.clearChatBtn.addEventListener('click', () => {
            localStorage.removeItem('chat_history');
            state.chatHistory = [];
            dom.chatLog.innerHTML = '';
            chat.addBotMessage("Chat history cleared.");
        });
        
        // Wizard Event Listeners
        dom.wizardNext.addEventListener('click', wizard.next);
        dom.wizardBack.addEventListener('click', wizard.back);
        dom.wizardHelp.addEventListener('click', wizard.askForHelp);
        dom.wizardClose.addEventListener('click', () => dom.wizardModal.classList.remove('open'));

        // Init
        ui.setupNavigation(); // Start Navigation Listener
        chat.init();
    </script>
</body>
</html>
