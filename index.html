<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMW G20 Dynamic Guide</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            overflow-x: hidden;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            width: 280px;
        }
        .sidebar.is-open {
            transform: translateX(0);
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
            .sidebar.is-collapsed {
                transform: translateX(-224px); /* width - collapsed width */
            }
            .main-content.sidebar-open {
                margin-left: 280px;
            }
            .main-content.sidebar-collapsed {
                margin-left: 56px; /* collapsed width */
            }
        }
        .nav-link.active {
            background-color: #eef2ff; /* indigo-100 */
            color: #4338ca; /* indigo-700 */
            font-weight: 600;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%;
            width: 24px; height: 24px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tool-tag { font-size: 0.65rem; font-weight: 600; padding: 2px 6px; border-radius: 9999px; margin-left: 8px; vertical-align: middle; }
        .tool-tag-blue { background-color: #dbeafe; color: #2563eb; }
        .tool-tag-purple { background-color: #ede9fe; color: #7c3aed; }
        .tool-tag-green { background-color: #dcfce7; color: #16a34a; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="relative min-h-screen">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar is-open bg-white fixed top-0 left-0 h-full z-40 border-r border-gray-200 flex flex-col">
            <div class="p-4 flex items-center justify-between border-b">
                <h1 class="text-xl font-bold text-gray-800 sidebar-text">G20 Guide</h1>
                <button id="sidebar-toggle-desktop" class="hidden lg:block p-1 rounded-full hover:bg-gray-200">
                    <svg data-lucide="chevrons-left" class="h-5 w-5 text-gray-600"></svg>
                </button>
                 <button id="sidebar-close-mobile" class="lg:hidden p-1 rounded-full hover:bg-gray-200">
                    <svg data-lucide="x" class="h-5 w-5 text-gray-600"></svg>
                </button>
            </div>
            <ul class="flex-1 overflow-y-auto p-2">
                <li><a href="#welcome" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="home" class="h-5 w-5"></svg><span class="sidebar-text">Welcome</span></a></li>
                
                <li class="px-3 mt-4 mb-2 text-xs font-semibold uppercase text-gray-400 sidebar-text">Tools</li>

                <li><a href="#bimmerlink" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="activity" class="h-5 w-5"></svg><span class="sidebar-text">BimmerLink</span></a></li>
                <li><a href="#bimmercode" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="code" class="h-5 w-5"></svg><span class="sidebar-text">BimmerCode</span></a></li>
                <li><a href="#bimmerutility" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="sliders-horizontal" class="h-5 w-5"></svg><span class="sidebar-text">BimmerUtility</span></a></li>
                
                <li class="px-3 mt-4 mb-2 text-xs font-semibold uppercase text-gray-400 sidebar-text">ECU Details</li>

                <li><a href="#hu" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="tv" class="h-5 w-5"></svg><span class="sidebar-text">Headunit</span></a></li>
                <li><a href="#ic" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="gauge-circle" class="h-5 w-5"></svg><span class="sidebar-text">Instrument Cluster</span></a></li>
                <li><a href="#bdc" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="car" class="h-5 w-5"></svg><span class="sidebar-text">Body Domain Controller</span></a></li>
                <li><a href="#dme" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="cpu" class="h-5 w-5"></svg><span class="sidebar-text">Engine (DME)</span></a></li>
                <li><a href="#egs" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="git-merge" class="h-5 w-5"></svg><span class="sidebar-text">Transmission (EGS)</span></a></li>
                <li><a href="#other" class="nav-link flex items-center gap-3 rounded-md px-3 py-2 text-gray-600 hover:bg-gray-100"><svg data-lucide="boxes" class="h-5 w-5"></svg><span class="sidebar-text">Other ECUs</span></a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main id="main-content" class="main-content sidebar-open p-4 sm:p-6 lg:p-8">
            <button id="sidebar-open-mobile" class="lg:hidden fixed top-4 left-4 h-12 w-12 bg-white rounded-full shadow-lg flex items-center justify-center z-30">
                <svg data-lucide="menu" class="h-6 w-6"></svg>
            </button>
            
            <div id="content-container">
                <!-- Welcome Section -->
                <section id="welcome" class="content-section">
                    <h2 class="text-4xl font-bold mb-4">Welcome to the G20 Advanced Guide</h2>
                    <p class="text-lg text-gray-600 mb-8">This page is a comprehensive resource for diagnosing, coding, and enhancing your BMW G20 series vehicle using popular mobile applications.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-3">What This Page Offers</h3>
                            <ul class="space-y-2 list-disc list-inside text-gray-700">
                                <li><b>Detailed Guides:</b> Step-by-step instructions for popular features across three major tools.</li>
                                <li><b>Expert Mode Parameters:</b> A clear list of expert coding parameters and their functions.</li>
                                <li><b>Tool-Specific Info:</b> Understand the difference between diagnostics (BimmerLink) and coding (BimmerCode/Utility).</li>
                                <li><b>AI-Powered Assistance:</b> Generate custom coding steps for your desired features instantly.</li>
                            </ul>
                        </div>
                         <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="text-2xl font-bold mb-3">The Tools Explained</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li><strong class="text-green-600">BimmerLink:</strong> For diagnostics. Read/clear errors, view live sensor data, and control functions like exhaust flaps. It does not make permanent changes.</li>
                                <li><strong class="text-blue-600">BimmerCode:</strong> For standard coding. Easily activate or deactivate common features in modules like the Headunit and Body Controller.</li>
                                <li><strong class="text-purple-600">BimmerUtility:</strong> For advanced coding. Access critical ECUs like the Engine and Transmission to perform performance-oriented modifications. Use with caution.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- AI Assistant -->
                    <div id="ai-assistant" class="bg-white rounded-xl shadow p-6 border border-gray-200">
                        <div class="flex items-center mb-4"><div class="p-2 bg-indigo-100 rounded-full mr-4"><svg data-lucide="sparkles" class="w-6 h-6 text-indigo-600"></svg></div><h2 class="text-2xl font-bold text-gray-900">AI Coding Assistant</h2></div>
                        <p class="text-gray-600 mb-4">Describe the feature you want to code (e.g., "Enable GTS startup roar"). The AI will generate steps for BimmerCode or BimmerUtility.</p>
                        <div class="space-y-4"><textarea id="ai-prompt" class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="Enter your desired coding feature here..."></textarea><button id="generate-btn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 flex items-center justify-center"><svg data-lucide="wand-2" class="w-5 h-5 mr-2"></svg><span>Generate Coding Steps</span></button></div>
                        <div id="ai-result-container" class="mt-6 hidden"><h3 class="text-xl font-semibold mb-3">Generated Steps:</h3><div id="ai-result" class="bg-gray-50 p-4 rounded-lg border"></div><div id="ai-loader" class="flex justify-center p-4"><div class="loader"></div></div></div>
                    </div>
                </section>

                <!-- Tool Content Sections -->
                <section id="bimmerlink" class="content-section">
                    <h2 class="text-3xl font-bold border-b pb-2 mb-6">BimmerLink <span class="tool-tag tool-tag-green">Diagnostics</span></h2>
                    <div class="space-y-6">
                        <div><h3 class="text-xl font-semibold">Read & Clear Error Codes</h3><p class="text-gray-600 mt-1">Scan all ECUs for Diagnostic Trouble Codes (DTCs) and clear them after repairs.</p></div>
                        <div><h3 class="text-xl font-semibold">Real-Time Sensor Values</h3><p class="text-gray-600 mt-1">Monitor hundreds of live sensor values like oil temperature, boost pressure, and battery voltage.</p></div>
                        <div><h3 class="text-xl font-semibold">Exhaust Flap Control</h3><p class="text-gray-600 mt-1">Temporarily open or close the exhaust flaps on demand, overriding the car's automatic control.</p></div>
                    </div>
                </section>
                
                <section id="bimmercode" class="content-section">
                     <h2 class="text-3xl font-bold border-b pb-2 mb-6">BimmerCode <span class="tool-tag tool-tag-blue">Standard Coding</span></h2>
                     <p class="text-gray-600">Use BimmerCode for safe, common modifications in non-critical ECUs. Below are Expert Mode parameters for popular features.</p>
                </section>
                
                <section id="bimmerutility" class="content-section">
                    <h2 class="text-3xl font-bold border-b pb-2 mb-6">BimmerUtility <span class="tool-tag tool-tag-purple">Advanced Coding</span></h2>
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg mb-6">
                        <div class="flex"><div class="py-1"><svg class="w-6 h-6 text-yellow-500 mr-4" data-lucide="alert-triangle"></svg></div><div><p class="font-bold text-yellow-800">Warning</p><p class="text-sm text-yellow-700">This tool modifies critical ECUs. Incorrect coding can lead to vehicle malfunction. Proceed with caution.</p></div></div>
                    </div>
                    <p class="text-gray-600">BimmerUtility provides access to ECUs like the Engine and Transmission for performance-oriented coding.</p>
                </section>
                
                <!-- ECU Content Sections -->
                <section id="hu" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Headunit (HU_MGU)</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">Video in Motion</h3><p class="text-gray-600 mt-1">Allows video playback while the vehicle is moving.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">SPEEDLOCK_X_KMH_MAX: FFFF</pre></div><div><h3 class="text-xl font-semibold">Disable Startup Warning</h3><p class="text-gray-600 mt-1">Removes the legal disclaimer on iDrive startup.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">MACRO_LEGALDISCLAIMER_SPEED: nicht_aktiv</pre></div></div></section>
                <section id="ic" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Instrument Cluster (DKOMBI)</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">Alpina Display Layout</h3><p class="text-gray-600 mt-1">Changes the cluster theme to the Alpina design.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">Layout: layout_alpina</pre></div><div><h3 class="text-xl font-semibold">M Performance Logo</h3><p class="text-gray-600 mt-1">Adds the "M Performance" logo to the cluster.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">LOGO_SCHRIFTZUG: m_performance</pre></div></div></section>
                <section id="bdc" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Body Domain Controller (BDC)</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">Fold Mirrors on Lock</h3><p class="text-gray-600 mt-1">Automatically folds mirrors when locking the car.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">KOMFORTSCHLIESSUNG_FB: aktiv</pre></div><div><h3 class="text-xl font-semibold">Turn Signal Blink Count</h3><p class="text-gray-600 mt-1">Changes the number of blinks for one-touch turn signal.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">BLINKZYKLEN_ANZAHL_TIPP: Werte=5</pre></div></div></section>
                <section id="dme" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Engine (DME)</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">GTS Startup Roar</h3><p class="text-gray-600 mt-1">Enables a louder engine sound on startup.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">Tool: BimmerUtility\nFunction: F8x_GTS_Start_up\nValue: Aktiv</pre></div><div><h3 class="text-xl font-semibold">Disable Auto Start/Stop</h3><p class="text-gray-600 mt-1">Permanently disables the Auto Start/Stop function.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">Tool: BimmerUtility\nFunction: MSA_ deaktivieren\nValue: Aktiv</pre></div></div></section>
                <section id="egs" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Transmission (EGS)</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">Alpina/M Transmission Flash</h3><p class="text-gray-600 mt-1">Flashes transmission software for faster shifts. This is a complex procedure, not a simple parameter change.</p></div></div></section>
                <section id="other" class="content-section"><h2 class="text-3xl font-bold border-b pb-2 mb-6">Other ECUs</h2><div class="space-y-6"><div><h3 class="text-xl font-semibold">Disable Active Sound (ASD)</h3><p class="text-gray-600 mt-1">Disables artificial engine noise played through speakers.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">Model: nicht_aktiv</pre></div><div><h3 class="text-xl font-semibold">Disable Seatbelt Reminders (ACSM)</h3><p class="text-gray-600 mt-1">Turns off the seatbelt warning chime.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">Gurtwarnung_Fahrer: nicht_aktiv</pre></div><div><h3 class="text-xl font-semibold">Remember A/C Setting (IHKA)</h3><p class="text-gray-600 mt-1">The car will remember if the A/C was off at shutdown.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">OFF_MEMORY: aktiv</pre></div><div><h3 class="text-xl font-semibold">Close Tailgate from Keyfob (HKFM)</h3><p class="text-gray-600 mt-1">Allows closing the power tailgate with the keyfob button.</p><pre class="text-sm bg-slate-200 p-3 rounded-md mt-2">SCH_FBD: aktiv</pre></div></div></section>
            </div>
        </main>
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();

        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const toggleDesktopBtn = document.getElementById('sidebar-toggle-desktop');
        const openMobileBtn = document.getElementById('sidebar-open-mobile');
        const closeMobileBtn = document.getElementById('sidebar-close-mobile');
        const overlay = document.getElementById('overlay');
        const navLinks = document.querySelectorAll('.nav-link');
        const contentSections = document.querySelectorAll('.content-section');

        // --- Sidebar Logic ---
        function toggleSidebarDesktop() {
            sidebar.classList.toggle('is-collapsed');
            mainContent.classList.toggle('sidebar-open');
            mainContent.classList.toggle('sidebar-collapsed');
            const icon = sidebar.classList.contains('is-collapsed') ? 'chevrons-right' : 'chevrons-left';
            toggleDesktopBtn.innerHTML = `<svg data-lucide="${icon}" class="h-5 w-5 text-gray-600"></svg>`;
            lucide.createIcons();
        }

        function toggleSidebarMobile() {
            sidebar.classList.toggle('is-open');
            overlay.classList.toggle('hidden');
        }

        toggleDesktopBtn.addEventListener('click', toggleSidebarDesktop);
        openMobileBtn.addEventListener('click', toggleSidebarMobile);
        closeMobileBtn.addEventListener('click', toggleSidebarMobile);
        overlay.addEventListener('click', toggleSidebarMobile);

        // --- Content Switching Logic ---
        function showContent(hash) {
            const targetHash = hash || '#welcome';
            
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === targetHash);
            });

            contentSections.forEach(section => {
                section.classList.toggle('active', `#${section.id}` === targetHash);
            });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetHash = link.getAttribute('href');
                window.location.hash = targetHash;
                if (window.innerWidth < 1024) {
                    toggleSidebarMobile();
                }
            });
        });
        
        window.addEventListener('hashchange', () => showContent(window.location.hash));
        // Initial load
        showContent(window.location.hash);

        // --- AI Assistant Logic ---
        const generateBtn = document.getElementById('generate-btn');
        const aiPrompt = document.getElementById('ai-prompt');
        const resultContainer = document.getElementById('ai-result-container');
        const aiResult = document.getElementById('ai-result');
        const aiLoader = document.getElementById('ai-loader');
        
        // --- MODIFIED: Use Cloudflare Worker for Gemini API calls ---
        async function callGeminiAPI(prompt) {
            resultContainer.style.display = 'block';
            aiResult.style.display = 'none';
            aiLoader.style.display = 'flex';

            // IMPORTANT: Replace this with your actual Cloudflare Worker URL
            const CLOUDFLARE_WORKER_URL = "https://healthfoodworker.rosucostine.workers.dev"; 
            
            // The system prompt needs to be combined with the user prompt
            // because the worker only accepts a single 'prompt' field.
            const systemPrompt = `You are an expert on BMW G20 coding using BimmerCode and BimmerUtility. A user will describe a feature. Provide clear, step-by-step instructions. For each step, you MUST specify the tool ("BimmerCode" or "BimmerUtility"), the ECU, the parameter, and the new value. If a feature requires both tools, clearly separate the steps. Format the response cleanly. Do not provide instructions for BimmerLink. User's request is: `;

            const combinedPrompt = systemPrompt + prompt;

            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: combinedPrompt })
                });

                if (!response.ok) {
                    throw new Error(`Cloudflare Worker error: ${response.status} ${response.statusText}`);
                }
                
                const text = await response.text();
                aiResult.textContent = text || 'Sorry, I could not generate the steps.';

            } catch (error) {
                console.error('Error calling Cloudflare Worker:', error);
                aiResult.textContent = 'An error occurred while fetching coding steps. Please ensure your worker URL is correct and the service is running.';
            } finally {
                aiLoader.style.display = 'none';
                aiResult.style.display = 'block';
            }
        }

        generateBtn.addEventListener('click', () => { 
            if (aiPrompt.value.trim()) {
                callGeminiAPI(aiPrompt.value);
            }
        });
    });
    </script>
</body>
</html>
